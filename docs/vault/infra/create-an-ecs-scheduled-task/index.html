<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">How To Create An ECS Scheduled Task | MilMove Developer Portal</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/vault/infra/create-an-ecs-scheduled-task"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="How To Create An ECS Scheduled Task | MilMove Developer Portal"><meta data-react-helmet="true" name="description" content="An ECS Scheduled Task is similar to a cron job. It runs a docker container inside our ECS Cluster in AWS on a"><meta data-react-helmet="true" property="og:description" content="An ECS Scheduled Task is similar to a cron job. It runs a docker container inside our ECS Cluster in AWS on a"><link data-react-helmet="true" rel="shortcut icon" href="/mymove-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/vault/infra/create-an-ecs-scheduled-task"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/vault/infra/create-an-ecs-scheduled-task" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/vault/infra/create-an-ecs-scheduled-task" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.2fa8fb56.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.a9d41c51.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.d3098497.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">MilMove.dev</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">APIs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/mymove-docs/api/prime">Prime</a></li><li><a class="dropdown__link" href="/mymove-docs/api/support">Support</a></li></ul></div><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/vault/">Documentation Vault</a></li><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/vault/[deprecated]-run-loki-tests-against-storybook">[deprecated]-run-loki-tests-against-storybook</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">confluence</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">infra</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/infra/How-to-use-the-benchmarking-script-with-Puppeteer-and-Lighthouse">Description</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/infra/Test-Sending-Email-in-Devlocal">Test-Sending-Email-in-Devlocal</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/infra/Test-Storing-Data-in-S3-in-Devlocal">Test-Storing-Data-in-S3-in-Devlocal</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/infra/anti_virus">Anti-Virus</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/vault/infra/create-an-ecs-scheduled-task">How To Create An ECS Scheduled Task</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/infra/run-against-s3-locally">How To Run Against S3 &amp; CDN Locally</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>How To Create An ECS Scheduled Task</h1></header><p>An ECS Scheduled Task is similar to a cron job. It runs a docker container inside our ECS Cluster in AWS on a
schedule defined by an CloudWatch Rule (typically a cron rule). These tasks can do things like update the DB on a
regular schedule or send out emails.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="writing-the-function"></a>Writing the Function<a class="hash-link" href="#writing-the-function" title="Direct link to heading">#</a></h2><p>You will need to start out by writing a new function to do the task locally. The code for this function
should go into the <code>cmd/milmove-tasks/</code> directory and be named similar to the command that will kick off your
scheduled task. For instance <code>save_fuel_price_data.go</code> is the code for running the ECS Scheduled Task for
saving fuel price data. You integrate this code into the <code>cmd/milmove-tasks/main.go</code> file using the
<a href="/mymove-docs/docs/vault/infra/github.com/spf13/cobra">spf13/cobra</a> library as a sub command. Once the binary has been compiled with
<code>make bin/milmove-tasks</code> your command should be runnable by calling <code>bin/milmove-tasks save-fuel-price-data</code> or
similar based on the name you chose.  Since you&#x27;re writing a sub-command the flags for that command will be
unique to your command alone and should be contained withing your golang file.</p><p><strong>WARNING:</strong> It is very important that your sub-command name is less than or equal to 25 characters. This same name
is referenced by the CircleCI and AWS terraform code to provision your task. The name must be identical in all
cases and names longer than 25 characters will throw errors when provisioning.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="test-the-code-locally"></a>Test the code locally<a class="hash-link" href="#test-the-code-locally" title="Direct link to heading">#</a></h2><p>You should be able to test the code locally either by running the code directly via <code>bin/milmove subcommand</code> or
via the <code>Makefile</code> targets you will need to create. In the file you should copy the target <code>tasks_save_fuel_price_data</code>
and make a similar target that matches your command in the section for <code>SCHEDULED TASK TARGETS</code> in the <code>Makefile</code>.
It is important that you pass in only the environment variables (designated by <code>-e</code>) that are needed for your task
and no more. Be as specific as possible. Then when you invoke <code>make tasks_your_subcommand</code> you should see the
<code>Dockerfile.tasks_local</code> file built and your command run.
that references your subcommand.</p><p><strong>WARNING:</strong> It is CRITICAL that the subcommand name you used earlier matches the <code>task_name</code> given to the module.
If the name doesn&#x27;t match then you won&#x27;t see the task work and the error messages you get will not be very helpful.</p><p>You will also want to write a cron job expression that matches how often you need to run the task. AWS has documentation
on <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions" target="_blank" rel="noopener noreferrer">Cron Expressions</a> that
you should reference as it is slightly different than normal cron expressions on Unix.</p><p>Lastly the Infra team needs to give your scheduled task access to the <a href="https://github.com/transcom/transcom-infrasec-com/blob/6e57f84b937376a1a5f4556869304ed81f453ef4/modules/aws-app-environment/main.tf#L213-L216" target="_blank" rel="noopener noreferrer">RDS IAM Role</a>. This has to happen after the ECS task is provisioned due to some odd behavior
of Terraform v0.11.</p><p>Your changes will now need to be deployed to all three environments: experimental, staging, and prod. This doesn&#x27;t mean
your code will begin running as the tasks haven&#x27;t been deployed by CircleCI at this point. That means its safe to provision
all of the environments in advance.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="aws-iam-permissions"></a>AWS IAM Permissions<a class="hash-link" href="#aws-iam-permissions" title="Direct link to heading">#</a></h3><p>The IAM Permissions for the task are managed in a <a href="https://github.com/transcom/transcom-infrasec-com/blob/6e57f84b937376a1a5f4556869304ed81f453ef4/modules/aws-app-environment/ecs-scheduled-task/main.tf#L149-L200" target="_blank" rel="noopener noreferrer">Task Role Policy</a>.
You would modify the policy if there is an action that your task needs that isn&#x27;t already available (like DB, S3, or
SES access). If you need to modify these to enable use of a new AWS resource please work with Infrastructure to
properly scope the access to be as narrow as possible for your task&#x27;s use case (ie no &quot;*&quot; resources if possible).
This is because your changes will be available to all the other tasks and may inadvertently give access to a resource
that another task shouldn&#x27;t have access to.  When in doubt please work with Infrastructure.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="aws-resource-throttling"></a>AWS Resource Throttling<a class="hash-link" href="#aws-resource-throttling" title="Direct link to heading">#</a></h3><p>Many of the resources in AWS have built-in throttling. For example you can only send up to 80 emails per second with
SES. Your code needs to be aware of these throttling limits and take into account errors when throttling limits are
hit. It&#x27;s also important that you add logging to your code so it&#x27;s easier to determine what went wrong in your code
when working with AWS resources.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="updating-circleci-to-deploy"></a>Updating CircleCI to Deploy<a class="hash-link" href="#updating-circleci-to-deploy" title="Direct link to heading">#</a></h2><p>To deploy with CircleCI you need to modify the <a href="https://github.com/transcom/mymove/blob/d676b217ea67dfd893d770a77bb9e2d898d0b891/.circleci/config.yml#L89-L98" target="_blank" rel="noopener noreferrer">deploy_tasks_steps</a>
in the <code>.circleci/config.yml</code>. Each scheduled task needs a separate <code>deploy:</code> section in this step. The important
parts to modify in the <code>deploy</code> section <code>command</code> argument is the flag <code>--command</code> and <code>--command-args</code>. These are
used by the <code>bin/ecs-deploy-task-container</code> code to create a Task Definition in ECS that is similar to a Dockerfile
with <code>--command</code> mapping to <code>entrypoint</code> and <code>--command-args</code> mapping to <code>command</code> in a Dockerfile.</p><p><strong>Note:</strong> You can deploy your code to the experimental environment to test things out at this point. It&#x27;s suggested that
you update the <code>cron</code> rule in terraform to run once per minute (if that doesn&#x27;t break throttling thresholds) so that you
can more quickly see if your code is doing what is expected.</p><p>Finally merge your code with the <code>master</code> branch and it will deploy in the regular manner of staging and then prod.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="viewing-logs"></a>Viewing logs<a class="hash-link" href="#viewing-logs" title="Direct link to heading">#</a></h2><p>Similar to the application all logs for ECS Scheduled Tasks will end up in AWS CloudWatch Logs.  For example,
if you want to see the scheduled task logs in experimental you&#x27;d go to the <code>ecs-tasks-app-experimental</code> Log Group
and search for a log stream named after your subcommand. For instance, with <code>save-fuel-price-data</code> the log stream is
named <code>app-tasks/app-tasks-save-fuel-price-data-experimental/TASKID</code> (where <code>TASKID</code> is a random string that
corresponds to the task ID of the last run task). You can look at the <code>Last Event Time</code> column to find the log
stream you are looking for. Open up the log stream and look at your data.</p><p><strong>WARNING:</strong> CloudWatch Insights is not super valuable for these kinds of logs. In general scheduled tasks run only
once per day or less and have very few log lines. If you use CloudWatch Insights you&#x27;ll get logs across multiple
log streams and not necessarily in an order that makes sense for the execution of the task. Please avoid using
CloudWatch Insights when debugging your task if you wish to save yourself a lot of pain.</p></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/vault/infra/create-an-ecs-scheduled-task.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mymove-docs/docs/vault/infra/anti_virus"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Anti-Virus</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mymove-docs/docs/vault/infra/run-against-s3-locally"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How To Run Against S3 &amp; CDN Locally Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#writing-the-function" class="table-of-contents__link">Writing the Function</a></li><li><a href="#test-the-code-locally" class="table-of-contents__link">Test the code locally</a><ul><li><a href="#aws-iam-permissions" class="table-of-contents__link">AWS IAM Permissions</a></li><li><a href="#aws-resource-throttling" class="table-of-contents__link">AWS Resource Throttling</a></li></ul></li><li><a href="#updating-circleci-to-deploy" class="table-of-contents__link">Updating CircleCI to Deploy</a></li><li><a href="#viewing-logs" class="table-of-contents__link">Viewing logs</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/help">Help</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/vault">Vault</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tutorial">Docusaurus Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/database">Database</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/testing">Testing</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 United States Transportation Command. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.a9d41c51.js"></script>
<script src="/mymove-docs/assets/js/main.d3098497.js"></script>
</body>
</html>