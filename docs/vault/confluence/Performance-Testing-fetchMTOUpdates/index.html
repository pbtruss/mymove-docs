<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">Performance Testing `fetchMTOUpdates` Query | MilMove Developer Portal</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/vault/confluence/Performance-Testing-fetchMTOUpdates"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Performance Testing `fetchMTOUpdates` Query | MilMove Developer Portal"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="shortcut icon" href="/mymove-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/vault/confluence/Performance-Testing-fetchMTOUpdates"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/vault/confluence/Performance-Testing-fetchMTOUpdates" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/vault/confluence/Performance-Testing-fetchMTOUpdates" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.2fa8fb56.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.671422c6.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.79d25a8b.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">MilMove.dev</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">APIs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/mymove-docs/api/prime">Prime</a></li><li><a class="dropdown__link" href="/mymove-docs/api/support">Support</a></li></ul></div><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/vault/">Documentation Vault</a></li><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/vault/[deprecated]-run-loki-tests-against-storybook">[deprecated]-run-loki-tests-against-storybook</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">confluence</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/Dependency-Update-Process-With-Dependabot">What is Dependabot</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/Deployment-Process">Deployment-Process</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/Disabled-or-Hidden-Moves">Disabled-or-Hidden-Moves</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/How-to-Run-Load-Testing-in-Experimental">How-to-Run-Load-Testing-in-Experimental</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/Load-Testing">Principles of Load Testing</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/vault/confluence/Performance-Testing-fetchMTOUpdates">Performance Testing `fetchMTOUpdates` Query</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox">Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/automatically-add-jira-id-to-commit-message">How to Automatically add JIRA ID to Commit Message</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/create-or-deactivate-users">How To Create or Deactivate Users</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/deploy-to-experimental">How to Deploy to Experimental or Demo</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/metrics">MilMove Application Metrics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/vault/confluence/pairing">Pairing Sessions</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">infra</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>Performance Testing <code>fetchMTOUpdates</code> Query</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>The <code>fetchMTOUpdates</code> endpoint in the Prime API is currently the main way for the Prime to retrieve information about moves the TOO has approved and sent to them, besides the push notification functionality. If push were to ever fail, this is their only way to rectify the situation.</p><p>This leaves us in a conundrum because this query is extremely inefficient. We are using Pop&#x27;s EagerPreload functionality to retrieve all nested info on the move and its orders, the shipments, the addresses, and so on. For the many thousands of moves we expect in peak season, this will not work. </p><p>We also want to give the Prime the ability to filter this list based off the last updated date of the move <em>and</em> it&#x27;s nested objects - shipments, service items, etc. This is a complex problem, and it is the main issue we are trying to address by rewriting this query. </p><p>We have completed the <a href="https://docs.google.com/document/d/1ggQrF7Cxq9Tfnzzv3WQeuJuJ7uB0txD0JYg69LwEK0k/edit#heading=h.d5b2vwy78o8j" target="_blank" rel="noopener noreferrer"><code>fetchMTOUpdates</code> Risk Assessment </a> to plan out our remediation of this endpoint. The steps are, briefly:</p><ol><li>Performance test the options for a <code>fetchMTOUpdates</code> query and implement the most performant.</li><li>Give the Prime other ways to retrieve move data.</li></ol><p>This analysis aims to complete Step 1 of this process. Most of these query options were pulled from <a href="https://trussworks.slack.com/archives/CDJ9JAD26/p1616628329057000" target="_blank" rel="noopener noreferrer">this slack thread</a>, with the necessary modifications to make this query fit our requirements.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="notes-on-the-test"></a>Notes on the test<a class="hash-link" href="#notes-on-the-test" title="Direct link to heading">#</a></h3><p>All query options below were run against a dataset with 91 total move records, 24 of which were available to Prime (<code>available_to_prime_at != null</code>).</p><p>We have the following requirements on the query:</p><ol><li>The Prime should get move data back. </li><li>No moves that are disabled or deleted should be returned. So <code>show = TRUE</code> is a requirement.</li><li>Only moves that are available to Prime should be returned.</li><li>The query should allow a <code>since</code> parameter to be passed in that allows the Prime to see the moves that have been updated or have had nested objects updated since that date.</li></ol><p>In an effort to give integrity to the tests, I tried to make each query fit these requirements as possible. However, there are some notable exceptions where the nature of the query made it difficult to create an equal playing field. </p><p>Most notably, Option 3 returns a significantly different dataset than the others. Option 1 also limits which columns can be in the SELECT statement due to the grouping. These issues will be further addressed with each test.</p><p>Furthermore, you might notice the absence of addresses in these queries. I will address that in the <a href="#conclusion">conclusion</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="how-to-read-the-results"></a>How to read the results<a class="hash-link" href="#how-to-read-the-results" title="Direct link to heading">#</a></h3><p>I use PSQL&#x27;s EXPLAIN ANALYZE command to get the test results. This gives me:</p><ul><li>Postgres&#x27; expected computation cost for each step of the query. This is an imaginary unit that roughly translates to how much time they expect the query to take.</li><li>The actual time the query took to execute. </li></ul><p>I will be giving most credence to the actual time spent on the query. But the potential CPU cost is important - the limits of our dataset can make a query seem faster than it will be in a production setting. I try to keep that in mind as well.</p><p>Note that UNIONS also seem to be quantifiably more efficient than JOINS: <a href="https://www.foxhound.systems/blog/sql-performance-with-union/" target="_blank" rel="noopener noreferrer">Speeding up SQL queries by orders of magnitude using UNION</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="tests"></a>Tests<a class="hash-link" href="#tests" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-1-max-greatest"></a>Option 1: Max Greatest<a class="hash-link" href="#option-1-max-greatest" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> mto_shipments </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> mto_service_items </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> payment_requests </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">available_to_prime_at </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">HAVING</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MAX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GREATEST</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This query joins the tables we need to check in our <code>since</code> parameter and then groups the results so that the MAX <code>updated_at</code> date can be aggregated. It is easy to read, relatively easy to filter, but we cannot grab extra columns from the JOINS because of that grouping.</p><p>EXPLAIN ANALYZE results:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">HashAggregate  (cost=33.83..34.00 rows=5 width=143) (actual time=35.382..35.789 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Group Key: moves.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  Filter: (max(GREATEST((moves.updated_at)::timestamp with time zone, (orders.updated_at)::timestamp with time zone, mto_shipments.updated_at, mto_service_items.updated_at, (payment_requests.updated_at)::timestamp with time zone)) &gt;= &#x27;2021-07-16 00:00:00+00&#x27;::timestamp with time zone)&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Rows Removed by Filter: 22</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Hash Right Join  (cost=20.48..32.81 rows=68 width=175) (actual time=27.970..31.985 rows=209 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Hash Cond: (payment_requests.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on payment_requests  (cost=0.00..11.20 rows=120 width=24) (actual time=0.114..0.653 rows=25 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Hash  (cost=20.00..20.00 rows=38 width=167) (actual time=27.779..28.065 rows=185 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              Buckets: 1024  Batches: 1  Memory Usage: 44kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Hash Right Join  (cost=14.98..20.00 rows=38 width=167) (actual time=16.767..22.930 rows=185 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Hash Cond: (mto_shipments.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Seq Scan on mto_shipments  (cost=0.00..4.14 rows=114 width=24) (actual time=0.041..1.531 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Hash  (cost=14.71..14.71 rows=22 width=159) (actual time=15.770..15.973 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Buckets: 1024  Batches: 1  Memory Usage: 27kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          -&gt;  Hash Right Join  (cost=7.49..14.71 rows=22 width=159) (actual time=11.020..14.393 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Hash Cond: (orders.id = moves.orders_id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Seq Scan on orders  (cost=0.00..6.33 rows=133 width=24) (actual time=0.030..1.729 rows=113 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Hash  (cost=7.22..7.22 rows=22 width=151) (actual time=9.642..9.737 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Buckets: 1024  Batches: 1  Memory Usage: 26kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      -&gt;  Hash Right Join  (cost=2.84..7.22 rows=22 width=151) (actual time=1.047..7.605 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            Hash Cond: (mto_service_items.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Seq Scan on mto_service_items  (cost=0.00..4.07 rows=107 width=24) (actual time=0.029..2.377 rows=108 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Hash  (cost=2.67..2.67 rows=14 width=143) (actual time=0.824..0.856 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  Buckets: 1024  Batches: 1  Memory Usage: 12kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  -&gt;  Seq Scan on moves  (cost=0.00..2.67 rows=14 width=143) (actual time=0.053..0.374 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        Filter: ((available_to_prime_at IS NOT NULL) AND show)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        Rows Removed by Filter: 67</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 1.038 ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 37.581 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-2-mad-joins"></a>Option 2: Mad Joins<a class="hash-link" href="#option-2-mad-joins" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> mto_shipments </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> mto_service_items </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> payment_requests </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">available_to_prime_at </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This query is extremely similar to the first, with the main difference being the compound OR statement instead of the GREATEST aggregate function.</p><p>EXPLAIN ANALYZE results:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">HashAggregate  (cost=33.34..33.48 rows=14 width=143) (actual time=25.897..26.724 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Group Key: moves.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Hash Right Join  (cost=20.48..33.28 rows=23 width=143) (actual time=24.569..26.278 rows=3 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Hash Cond: (payment_requests.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Filter: ((moves.updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone) OR (orders.updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone) OR (mto_shipments.updated_at &gt;= &#x27;2021-07-16 00:00:00+00&#x27;::timestamp with time zone) OR (mto_service_items.updated_at &gt;= &#x27;2021-07-16 00:00:00+00&#x27;::timestamp with time zone) OR (payment_requests.updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Rows Removed by Filter: 206</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on payment_requests  (cost=0.00..11.20 rows=120 width=24) (actual time=0.040..0.432 rows=25 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Hash  (cost=20.00..20.00 rows=38 width=167) (actual time=24.479..24.936 rows=185 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              Buckets: 1024  Batches: 1  Memory Usage: 44kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Hash Right Join  (cost=14.98..20.00 rows=38 width=167) (actual time=17.456..22.166 rows=185 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Hash Cond: (mto_shipments.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Seq Scan on mto_shipments  (cost=0.00..4.14 rows=114 width=24) (actual time=0.026..1.373 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Hash  (cost=14.71..14.71 rows=22 width=159) (actual time=16.364..16.589 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Buckets: 1024  Batches: 1  Memory Usage: 27kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          -&gt;  Hash Right Join  (cost=7.49..14.71 rows=22 width=159) (actual time=8.800..14.358 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Hash Cond: (orders.id = moves.orders_id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Seq Scan on orders  (cost=0.00..6.33 rows=133 width=24) (actual time=0.026..1.943 rows=113 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Hash  (cost=7.22..7.22 rows=22 width=151) (actual time=7.921..8.059 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Buckets: 1024  Batches: 1  Memory Usage: 26kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      -&gt;  Hash Right Join  (cost=2.84..7.22 rows=22 width=151) (actual time=1.478..6.331 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            Hash Cond: (mto_service_items.move_id = moves.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Seq Scan on mto_service_items  (cost=0.00..4.07 rows=107 width=24) (actual time=0.082..1.728 rows=108 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Hash  (cost=2.67..2.67 rows=14 width=143) (actual time=1.323..1.377 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  Buckets: 1024  Batches: 1  Memory Usage: 12kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  -&gt;  Seq Scan on moves  (cost=0.00..2.67 rows=14 width=143) (actual time=0.030..0.488 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        Filter: ((available_to_prime_at IS NOT NULL) AND show)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        Rows Removed by Filter: 67</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 0.630 ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 27.110 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-3-flattening"></a>Option 3: Flattening<a class="hash-link" href="#option-3-flattening" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> orders_flat </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> orders_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> item_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;ORDER&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> orders  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> o1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        sm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;CUSTOMER&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> orders o1  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> service_members sm </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> o1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">service_member_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> move_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SI&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_service_items  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;MOVE&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> move_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;SHIPMENT&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_shipments  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> move_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;PAYMENTREQ&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> payment_requests pr  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> move_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">MAX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orders_flat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&#x27;ORDER&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> type_name  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders_flat </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orders_flat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">available_to_prime_at </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      orders_flat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This query takes a markedly different approach from the others. It flattens the full dataset into a table of IDs and a column for the name of the object the IDs belong to. This results of this query would therefore need to be massaged into a form that groups objects based on the move they belong to, which may be disadvantageous. This query would likely need to be run into something akin to a MATERIALIZED VIEW to handle the output. </p><p>Note that it does, however, give a more complete image of all the objects involved in the <code>since</code> check, which is missing from all other options. It also grabs the service member info, which I have left off of other queries. I discuss what info should be pulled out of the queries more in the conclusion.</p><p>EXPLAIN ANALYZE results:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Append  (cost=0.00..55.35 rows=414 width=72) (actual time=0.145..42.856 rows=327 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Seq Scan on mto_service_items  (cost=0.00..4.07 rows=107 width=72) (actual time=0.122..1.919 rows=108 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  -&gt;  Subquery Scan on &quot;&quot;*SELECT* 2&quot;&quot;  (cost=0.00..3.51 rows=67 width=72) (actual time=0.048..4.766 rows=91 loops=1)&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on moves  (cost=0.00..2.67 rows=67 width=72) (actual time=0.025..1.940 rows=91 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Seq Scan on mto_shipments  (cost=0.00..4.14 rows=114 width=72) (actual time=0.041..1.983 rows=102 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  -&gt;  Subquery Scan on &quot;&quot;*SELECT* 4&quot;&quot;  (cost=0.00..12.70 rows=120 width=72) (actual time=0.049..0.864 rows=25 loops=1)&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on payment_requests pr  (cost=0.00..11.20 rows=120 width=72) (actual time=0.028..0.270 rows=25 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  -&gt;  Subquery Scan on &quot;&quot;*SELECT* 5&quot;&quot;  (cost=26.47..26.65 rows=6 width=72) (actual time=23.995..24.474 rows=1 loops=1)&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  GroupAggregate  (cost=26.47..26.58 rows=6 width=72) (actual time=23.948..24.379 rows=1 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              Group Key: moves_1.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Sort  (cost=26.47..26.49 rows=6 width=40) (actual time=23.765..24.218 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Sort Key: moves_1.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Sort Method: quicksort  Memory: 25kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Hash Join  (cost=2.84..26.40 rows=6 width=40) (actual time=2.783..23.987 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Hash Cond: (orders.id = moves_1.orders_id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Join Filter: ((moves_1.updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone) OR (orders.updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Rows Removed by Join Filter: 46</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          -&gt;  Append  (cost=0.00..22.27 rows=266 width=24) (actual time=0.046..20.424 rows=226 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Seq Scan on orders  (cost=0.00..6.33 rows=133 width=24) (actual time=0.028..1.801 rows=113 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;                                -&gt;  Subquery Scan on &quot;&quot;*SELECT* 2_1&quot;&quot;  (cost=6.59..14.61 rows=133 width=24) (actual time=4.801..13.246 rows=113 loops=1)&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      -&gt;  Hash Join  (cost=6.59..13.28 rows=133 width=72) (actual time=4.770..9.817 rows=113 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            Hash Cond: (o1.service_member_id = sm.id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Seq Scan on orders o1  (cost=0.00..6.33 rows=133 width=32) (actual time=0.086..1.771 rows=113 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            -&gt;  Hash  (cost=5.15..5.15 rows=115 width=24) (actual time=4.370..4.404 rows=115 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  Buckets: 1024  Batches: 1  Memory Usage: 15kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  -&gt;  Seq Scan on service_members sm  (cost=0.00..5.15 rows=115 width=24) (actual time=0.085..2.318 rows=115 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                          -&gt;  Hash  (cost=2.67..2.67 rows=14 width=40) (actual time=0.644..0.688 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Buckets: 1024  Batches: 1  Memory Usage: 10kB</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -&gt;  Seq Scan on moves moves_1  (cost=0.00..2.67 rows=14 width=40) (actual time=0.036..0.309 rows=24 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Filter: ((available_to_prime_at IS NOT NULL) AND show)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Rows Removed by Filter: 67</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 0.699 ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 47.929 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-4-unions"></a>Option 4: Unions<a class="hash-link" href="#option-4-unions" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">available_to_prime_at </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_shipments  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_service_items  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> payment_requests  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> orders  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This approach uses UNIONS instead of JOINS, which are quantifiably more efficient. The OR checks also save a lot of the heavy processing for the cases where it is actually needed, as opposed to always doing it upfront. </p><p>EXPLAIN ANALYZE results:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Seq Scan on moves  (cost=28.19..31.36 rows=11 width=143) (actual time=1.345..1.711 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Filter: ((available_to_prime_at IS NOT NULL) AND show AND ((updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone) OR (hashed SubPlan 1) OR (hashed SubPlan 2)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  Rows Removed by Filter: 89</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SubPlan 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -&gt;  HashAggregate  (cost=21.00..21.42 rows=42 width=16) (actual time=1.066..1.188 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          Group Key: mto_shipments.move_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          -&gt;  Append  (cost=0.00..20.89 rows=42 width=16) (actual time=0.177..1.024 rows=2 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;  Seq Scan on mto_shipments  (cost=0.00..4.42 rows=1 width=16) (actual time=0.137..0.208 rows=1 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Filter: (updated_at &gt;= &#x27;2021-07-16 00:00:00+00&#x27;::timestamp with time zone)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Rows Removed by Filter: 101</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;  Seq Scan on mto_service_items  (cost=0.00..4.34 rows=1 width=16) (actual time=0.357..0.388 rows=1 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Filter: (updated_at &gt;= &#x27;2021-07-16 00:00:00+00&#x27;::timestamp with time zone)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Rows Removed by Filter: 107</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt;  Seq Scan on payment_requests  (cost=0.00..11.50 rows=40 width=16) (actual time=0.082..0.091 rows=0 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Filter: (updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Rows Removed by Filter: 25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SubPlan 2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -&gt;  Seq Scan on orders  (cost=0.00..6.66 rows=1 width=16) (actual time=0.065..0.075 rows=0 loops=1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          Filter: (updated_at &gt;= &#x27;2021-07-16 00:00:00&#x27;::timestamp without time zone)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          Rows Removed by Filter: 113</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 2.505 ms</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 2.550 ms</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="simplified-results"></a>Simplified Results<a class="hash-link" href="#simplified-results" title="Direct link to heading">#</a></h2><table><thead><tr><th></th><th>Option 1</th><th>Option 2</th><th>Option 3</th><th>Option 4</th></tr></thead><tbody><tr><td><strong>Potential CPU Cost</strong></td><td>34.00</td><td>33.48</td><td>55.35</td><td>31.36</td></tr><tr><td><strong>Total Processing Time</strong></td><td>38.619 ms</td><td>27.740 ms</td><td>48.618 ms</td><td>5.055 ms</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="winner"></a>Winner<a class="hash-link" href="#winner" title="Direct link to heading">#</a></h2><p><strong>Option 4: Unions</strong> had the best results. Notable downsides are that we cannot see the connected shipments, service items, or payment requests. This is a consistent theme for all options except the flattening one, which was the most expensive by far. The moral here is that we need to limit our references to get any real gains in performance.</p><p>This query is also easily manipulated in case we need to update it later. For example, here&#x27;s a version that JOINS with orders for the sake of returning more useful information in the output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">report_by_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_number  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> moves  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">orders_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">available_to_prime_at </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">show</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       orders</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">moves</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_shipments  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> mto_shipments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> mto_service_items  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> mto_service_items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">UNION</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">move_id  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> payment_requests  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> payment_requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updated_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021/07/16&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And the results are still great, with a max cost of 31.44 and total time of 4.951 ms.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>We have to make concessions to have a performant fetch query on all moves. These queries are comparable as they are, but in reality, there is even more depth to evaluate for an <code>updatedAt</code> that meets the criteria. We may have to just accept that it is not reasonable to take all sub-objects into consideration for this query. In particular:</p><ul><li>We can skip <code>entitlements</code>. An entitlement should never be updated without the corresponding order being amended and updated as well. So <code>orders.updated_at</code> is sufficient for entitlements.</li><li>We can skip <code>duty_stations</code> and their connected addresses. A duty station itself should not be updated significantly (can&#x27;t just move a whole station to a new zipcode willy nilly). If a duty station is changed, the order will be updated with the new foreign key reference. Therefore, <code>orders.updated_at</code> is also sufficient in this case.</li></ul><p>More difficult choices:</p><ul><li>We can skip the subobjects in <code>mto_shipments</code>, <code>mto_service_items</code>, and <code>payment_requests</code>. This is, frankly, not actually ideal. However, many of the updates to these subobjects are either automatic or coming from the Prime themselves. Additionally, the main <code>status</code> field that is the most important related to processing is on these main objects. Decisions from the TOO or TIO should accompany most updates, so basing our filter on the parent object might actually catch almost all updates of the subobjects as well.</li><li>We can skip the updates to <code>service_member</code>. This is not covered by other updates, unfortunately. But from a process perspective, this info is not critical for the execution of the move (although it is important for coordinating with the customer). </li></ul><p>Ultimately, one fail safe is not enough to cover the potential failure of push notifications. We cannot, and we <em>should not</em> rely on one fetch to fill in the gaps for the Prime. We should instead provide a variety of methods for the Prime to search for the data they need.</p><p>To that end, pagination and filtering, in addition to a shipment list endpoint, would be great additions to the Prime API. More flexible GETs are our allies in a more performant system.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="implementation"></a>Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">#</a></h2><p>The next steps to implement this new query will be:</p><ul><li>Update the service object <code>fetchMTOUpdates</code> points at to use this new query. Check that no other endpoints are adversely affected by this.</li><li>Update the <code>prime.yaml</code> to show that the endpoint will no longer return info on all nested objects.</li><li>Add a <code>getMoveByLocator</code> endpoint to allow more flexibility in how we retrieve moves. Not required, but would be nice to have.</li><li>Consider a <code>listShipments</code> endpoint that has pagination and filtering.</li><li>Consider more fetch endpoints.</li></ul></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/vault/confluence/Performance-Testing-fetchMTOUpdates.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mymove-docs/docs/vault/confluence/Load-Testing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Principles of Load Testing</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mymove-docs/docs/vault/confluence/Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a><ul><li><a href="#notes-on-the-test" class="table-of-contents__link">Notes on the test</a></li><li><a href="#how-to-read-the-results" class="table-of-contents__link">How to read the results</a></li></ul></li><li><a href="#tests" class="table-of-contents__link">Tests</a><ul><li><a href="#option-1-max-greatest" class="table-of-contents__link">Option 1: Max Greatest</a></li><li><a href="#option-2-mad-joins" class="table-of-contents__link">Option 2: Mad Joins</a></li><li><a href="#option-3-flattening" class="table-of-contents__link">Option 3: Flattening</a></li><li><a href="#option-4-unions" class="table-of-contents__link">Option 4: Unions</a></li></ul></li><li><a href="#simplified-results" class="table-of-contents__link">Simplified Results</a></li><li><a href="#winner" class="table-of-contents__link">Winner</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li><li><a href="#implementation" class="table-of-contents__link">Implementation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/help">Help</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/vault">Vault</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tutorial">Docusaurus Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/contributing/database">Database</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/dev/testing">Testing</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 United States Transportation Command. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.671422c6.js"></script>
<script src="/mymove-docs/assets/js/main.79d25a8b.js"></script>
</body>
</html>