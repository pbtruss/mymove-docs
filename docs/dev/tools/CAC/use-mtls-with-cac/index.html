<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">How to Create CAC Access (for using Prime API and uploading Electronic Orders) | MilMove Developer Portal</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/dev/tools/CAC/use-mtls-with-cac"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="How to Create CAC Access (for using Prime API and uploading Electronic Orders) | MilMove Developer Portal"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="shortcut icon" href="/mymove-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/dev/tools/CAC/use-mtls-with-cac"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/dev/tools/CAC/use-mtls-with-cac" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/dev/tools/CAC/use-mtls-with-cac" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.2fa8fb56.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.cd165c61.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.8b649ace.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">MilMove Documentation</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/frontend">Frontend</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/backend">Backend</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/api">API</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/tools">Tools</a><a class="navbar__item navbar__link navbar__link--active" href="/mymove-docs/docs/">Docs</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/index">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/">MilMove Developer Docs</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contributing</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Testing</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Tools</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">CAC</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/dev/tools/CAC/Using-your-CAC-in-Browsers-on-MacOS">Using-your-CAC-in-Browsers-on-MacOS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/dev/tools/CAC/upload-electronic-orders">How to Upload Electronic Orders Using your CAC</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/dev/tools/CAC/use-mtls-with-cac">How to Create CAC Access (for using Prime API and uploading Electronic Orders)</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Demo</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>How to Create CAC Access (for using Prime API and uploading Electronic Orders)</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Mutual TLS is used in the app to authenticate traffic. Users are authorized by comparing a SHA 256 hash of the
public certificate in the presented certificate, which is stored on the user&#x27;s CAC.
To get that information into the system we must create a <a href="https://github.com/transcom/mymove/blob/master/docs/database/migrate-the-database.md#secure-migrations" target="_blank" rel="noopener noreferrer">secure migration</a> that contains both the
SHA 256 fingerprint and the Subject on the CAC certificate.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="requirements"></a>Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">#</a></h2><p>The requirements are that you have a CAC and a CAC Reader. The recommended reader is the <a href="https://www.amazon.com/Reader-Saicoo-Military-Compatible-Windows/dp/B071NT53M7/ref=sr_1_4" target="_blank" rel="noopener noreferrer">Type C Smart Card Reader
Saicoo DOD Military USB-C Common Access Card Reader</a>.</p><p>To get going, install software on your machine with this command:</p><p> <code>brew install opensc</code></p><p> It gives you tools like <code>pkcs11-tool</code> and <code>pkcs15-tool</code>.
You need the library which gets placed in <code>/usr/local/lib/pkcs11/opensc-pkcs11.so</code> and is installed with <code>opensc</code></p><p> Note: You will not need to install a driver for the card reader.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h2><ol><li><p>To see if you are in a place to use your CAC to extract certs you need to run these commands:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  cac-prereqs</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  prereqs</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Plug in your card reader to your computer</p></li><li><p>Insert your CAC into the reader</p></li></ol><blockquote><p>Your laptop may prompt you to &quot;pair&quot; with your CAC. You can cancel out of this, it is not necessary for these purposes and can cause other issues.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="generating-a-secure-migration"></a>Generating a Secure Migration<a class="hash-link" href="#generating-a-secure-migration" title="Direct link to heading">#</a></h2><p>To generate the secure migration run this step:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">milmove gen certs-migration --name &quot;${USER}_cac&quot; --cac</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong><em>NOTE: If you want to update your cac run instead</em></strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">milmove gen certs-migration --name &quot;${USER}_cac&quot; --cac --update --certid &lt;uuid from original cert migration&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You will see output like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">2019/08/22 17:32:38 new migration file created at: &quot;tmp/20190822173238_cgilmer_cac.up.sql&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2019/08/22 17:32:38 new migration file created at:  &quot;migrations/app/secure/20190822173238_cgilmer_cac.up.sql&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2019/08/22 17:32:38 new migration appended to manifest at: &quot;/dir/transcom/mymove/migrations/app/migrations_manifest.txt&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The generation script will do the following:</p><ul><li>Create a stub local secure migration in the <code>migrations/app/secure/</code> folder</li><li>Create a migration to upload to AWS S3 in the <code>tmp/</code> folder</li><li>Update the <code>migrations_manifest.txt</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="troubleshooting"></a>Troubleshooting<a class="hash-link" href="#troubleshooting" title="Direct link to heading">#</a></h3><ul><li>If you have a Yubikey plugged in, you may get an error message (<code>pkcs11: the token has no such object</code>) because it is trying to read the Yubikey instead of your CAC. Try removing the Yubikey.</li><li>Use <code>opensc-tool -l</code> to make sure the CAC reader is detected</li><li>Use <code>pkcs11-tool --list-token-slots</code> to make sure your CAC is detected by the reader</li><li>[[Troubleshoot-CAC-Reader-Issues]]</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="preparing-for-upload"></a>Preparing for Upload<a class="hash-link" href="#preparing-for-upload" title="Direct link to heading">#</a></h2><p>You will be uploading the migration from the <code>tmp/</code> directory, ONLY to the Staging and Experimental environments.</p><p><strong>DO NOT UPLOAD THIS MIGRATION TO PRODUCTION AS THERE SHOULD BE NO USE CASE FOR USING A PERSONAL CAC TO UPLOAD ORDERS IN PROD</strong>.</p><p>Before uploading we&#x27;ll remove some sensitive information and verify the migration script runs locally.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="testing-certificate-locally"></a>Testing Certificate Locally<a class="hash-link" href="#testing-certificate-locally" title="Direct link to heading">#</a></h3><p>For testing locally:</p><ol><li><p>copy the <code>tmp</code> migration file contents to the corresponding file in <code>migrations/app/secure/</code> (your file name will be different):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cp tmp/20190822181328_cgilmer_cac.up.sql migrations/app/secure/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Change the migration sql file in <code>migrations/app/secure/</code> (which is for Devlocal only) by updating the <code>CN</code> field with your GitHub username.
This will prevent your name and EDIPI from getting checked into git.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Example:</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">```tex</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CN=LAST.FIRST.MI.EDIPI,OU=DoD+OU=PKI+OU=CONTRACTOR,O=U.S. Government,C=US</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># should be</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CN=GITHUB_USERNAME,OU=DoD+OU=PKI+OU=CONTRACTOR,O=U.S. Government,C=US</span></span><span class="token-line" style="color:#393A34"><span class="token plain">```</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Note: After your secure migration of `tmp` file, staging and experimental migration files will continue to have your name and EDIPI in the format `CN=LAST.FIRST.MIDDLE.EDIPI,...`).</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Test this by running:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> db_dev_migrate</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Make a branch with only the secure migration sql file located in <code>migrations/app/secure</code> and the <code>migrations_manifest.txt</code> file.</p></li><li><p>Validate your client certificate was updated (use your username):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">psql-dev</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; select * from client_certs where subject ILIKE &#x27;%GITHUB_USERNAME%&#x27;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>To test, run the server and test the secure migration (with your CAC inserted into your reader):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">make db_dev_e2e_populate server_run</span></span><span class="token-line" style="color:#393A34"><span class="token plain">go run ./cmd/prime-api-client  fetch-mto-updates --cac --insecure</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If the secure migration worked you should receive a response similar to</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;createdAt&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-01-22&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5d4b25bb-eb04-4c03-9a81-ee0398cb7791&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;isAvailableToPrime&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;isCanceled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;moveOrderID&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;6fca843a-a87e-4752-b454-0fac67aa4981&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;mto_service_items&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;payment_requests&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;mto_shipments&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;updatedAt&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-01-22&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="uploading-cac-secure-migration"></a>Uploading CAC Secure Migration<a class="hash-link" href="#uploading-cac-secure-migration" title="Direct link to heading">#</a></h2><p>Once the files have been generated by previous section next step is to upload them to the environments.</p><ol><li><p>Upload to <code>exp</code> and <code>stg</code> using the file in <code>tmp/</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">ENVIRONMENTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;exp stg&quot;</span><span class="token plain"> ./scripts/upload-secure-migration tmp/20200211150405_mr337_cac.up.sql</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should use your AWS Govcloud MFA here. The script will prompt you to confirm upload</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> Are you ready to upload your new migration? This will upload to the following GovCloud environments: exp stg. (y/N) y</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Uploading to: exp</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> Uploading to: stg</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>For <code>prd</code> <strong>do not</strong> upload the <code>tmp</code> file. Instead we&#x27;ll upload a stub file as a place holder since the migration process will be looking for such a file in <code>prd</code> environment.</p><p>Remove the contents of your <code>tmp</code> file and then paste <code>-- This is a stub file for user [YOUR USERNAME]</code></p><p>OR</p><p>Use this command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- This is a stub file for user </span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable environment constant" style="color:#36acaa">USER</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> tmp/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ENVIRONMENTS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">prd ./scripts/upload-secure-migration tmp/20200211150405_mr337_cac.up.sql</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The file should be empty except for the comment <code>-- This is a stub file for user [YOUR USERNAME]</code></p></li><li><p>Once completed confirm the upload with the command <code>download-secure-migration</code></p><ul><li>Ensure the secure migration files for <code>exp</code> and <code>stg</code> inserts a new record into the database with sensitive information.</li><li>Ensure the secure migration file for <code>prd</code> is just a stub and does not insert a record</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">download-secure-migration 20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading from: exp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">download: s3://transcom-gov-milmove-exp-app-us-gov-west-1/secure-migrations/20200211150405_mr337_cac.up.sql to ./tmp/secure_migrations/exp/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading from: stg</span></span><span class="token-line" style="color:#393A34"><span class="token plain">download: s3://transcom-gov-milmove-stg-app-us-gov-west-1/secure-migrations/20200211150405_mr337_cac.up.sql to ./tmp/secure_migrations/stg/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Downloading from: prd</span></span><span class="token-line" style="color:#393A34"><span class="token plain">.download: s3://transcom-gov-milmove-prd-app-us-gov-west-1/secure-migrations/20200211150405_mr337_cac.up.sql to ./tmp/secure_migrations/prd/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Files have been downloaded to these locations:</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">./tmp/secure_migrations/prd/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">./tmp/secure_migrations/exp/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain">./tmp/secure_migrations/stg/20200211150405_mr337_cac.up.sql</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Please remember to </span><span class="token string" style="color:#e3116c">&#x27;rm -rf ./tmp/secure_migrations&#x27;</span><span class="token plain"> when you are finished working</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Create a PR with the branch created earlier, with only the secure migration sql file located in <code>migrations/app/secure</code> and the <code>migrations_manifest.txt</code> file. Once merged, you can test on staging.</p></li><li><p><a href="https://github.com/transcom/mymove/wiki/How-to-Test-the-Prime-API-(Local,-Staging,-and-Experimental)" target="_blank" rel="noopener noreferrer">Test Prime API on staging and experimental</a></p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="manually-generating-a-secure-migration"></a>Manually Generating a Secure Migration<a class="hash-link" href="#manually-generating-a-secure-migration" title="Direct link to heading">#</a></h2><p><strong>NOTE:</strong>  Only follow these steps if you need to manually extract values from a CAC that you don&#x27;t have physical access to.</p><ol><li><p>To get the Fingerprint and Subject the user can run these commands:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cac-extract-fingerprint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cac-extract-subject</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Now you need to generate the secure migration with these scripts:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">FINGERPRINT=`cac-extract-fingerprint`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SUBJECT=`cac-extract-subject`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">milmove gen certs-migration --name &quot;${USER}_cac&quot; -f &quot;${FINGERPRINT}&quot; -s &quot;${SUBJECT}&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The output is the same as in the above steps.</p></li></ol></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/dev/tools/CAC/use-mtls-with-cac.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mymove-docs/docs/dev/tools/CAC/upload-electronic-orders"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« How to Upload Electronic Orders Using your CAC</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mymove-docs/docs/dev/Demo/Slice Demo Prep/Prime-Demo-Script-Postman-Setup"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Utilizing the GitHub Workflow for designing a Slice Demo Postman Collection: Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#requirements" class="table-of-contents__link">Requirements</a></li><li><a href="#prerequisites" class="table-of-contents__link">Prerequisites</a></li><li><a href="#generating-a-secure-migration" class="table-of-contents__link">Generating a Secure Migration</a><ul><li><a href="#troubleshooting" class="table-of-contents__link">Troubleshooting</a></li></ul></li><li><a href="#preparing-for-upload" class="table-of-contents__link">Preparing for Upload</a><ul><li><a href="#testing-certificate-locally" class="table-of-contents__link">Testing Certificate Locally</a></li></ul></li><li><a href="#uploading-cac-secure-migration" class="table-of-contents__link">Uploading CAC Secure Migration</a></li><li><a href="#manually-generating-a-secure-migration" class="table-of-contents__link">Manually Generating a Secure Migration</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tutorial">Docusaurus Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tools">Tools</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>MilMove Documentation GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>MilMove GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 United States Transportation Command. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.cd165c61.js"></script>
<script src="/mymove-docs/assets/js/main.8b649ace.js"></script>
</body>
</html>