<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">Turning TDL scores and TSP discounts into transportation service provider performances | MilMove Developer Portal</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Turning TDL scores and TSP discounts into transportation service provider performances | MilMove Developer Portal"><meta data-react-helmet="true" name="description" content="This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance."><meta data-react-helmet="true" property="og:description" content="This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance."><link data-react-helmet="true" rel="shortcut icon" href="/mymove-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://transcom.github.io/mymove-docs/docs/backend/guides/tspp-data-creation" hreflang="x-default"><link rel="stylesheet" href="/mymove-docs/assets/css/styles.2fa8fb56.css">
<link rel="preload" href="/mymove-docs/assets/js/runtime~main.05ef37e2.js" as="script">
<link rel="preload" href="/mymove-docs/assets/js/main.8b649ace.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mymove-docs/"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mymove-docs/img/logo.svg" alt="MilMove Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">MilMove Documentation</b></a><a class="navbar__item navbar__link" href="/mymove-docs/docs/about/">About</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/frontend">Frontend</a><a class="navbar__item navbar__link navbar__link--active" href="/mymove-docs/docs/backend">Backend</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/api">API</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/tools">Tools</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/">Docs</a><a class="navbar__item navbar__link" href="/mymove-docs/docs/help/index">Help</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>mymove<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mymove-docs/docs/backend">MilMove Backend</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Testing</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/service-objects">Backend Service Objects Development Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/backend-structure">Backend Structure</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/tariff400ng_items-update-data">Adding ShipmentLineItem records to the 400ng table (tariff400ng_items)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/database">Database Guides</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/feature-flags-in-the-app">Feature flags in the app</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Global Household Goods Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/guide-to-static-analysis-annotations-for-disabled-linters">Guide to Static Analysis Annotations for Disabled Linters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/guide-to-static-analysis-security-workflow">Guide to Static Analysis Security Workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/access-global-variables">How to Access a Global Application Variable</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">How-to guides</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/troubleshoot-gex-connection">Troubleshoot GEX Connection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/tariff400ng-yearly-import">Importing tariff400ng data for the year</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/troubleshoot-precommit-hook-failures">Precommit Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/route-planner">Route Planner Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/session-management">Session management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/switching-over-to-nix">Switching over to Nix</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/golang-time">Time in Golang</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/golang-loops">Loop Iteration in Golang</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/mymove-docs/docs/backend/guides/tspp-data-creation">Turning TDL scores and TSP discounts into transportation service provider performances</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/use-optimistic-locking">What Is Optimistic Locking?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/wip-server-side-validation">WIP server-side validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/zip-code-to-rate-area-mappings">Zip code to Rate area mappings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mymove-docs/docs/backend/guides/open-telemetry">Open Telemetry</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Setup</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>Turning TDL scores and TSP discounts into transportation service provider performances</h1></header><p>This outlines the steps you need to do to join the two data sources we&#x27;ve traditionally gotten - CSVs or text files of best value scores tied to TDLs, exported one code of service at a time, and CSVs or text files of TSP discount rates, organized by the three pieces of data that make up a TDL (origin, destination, and code of service). If anything behaves in a surprising way, double check the schema detailed here against the organization of your input files. No step of this should alter zero rows, for instance.</p><p>Before you begin this process, convert discount rate Excel files or txt files to CSVs, if needed. <strong>Verify that values for SVY_SCORE, RATE_SCORE, and BVS are decimal values (should be formatted like <code>77.3456</code>).</strong></p><blockquote><p>We will use the <code>\copy</code> <code>psql</code> command throughout this guide.</p><p><code>\copy</code> is a simpler way of getting this into the db because it requires less in the way of user permissions (unlike the <code>COPY</code> command). Use your absolute path for where you stored those CSV files.</p></blockquote><p>Note: If you wish to view existing data from production, use the command <code>bin/run-prod-migrations</code>. The local development <code>dev-db</code>
does not contain the full set of data. You should not need to run the command <code>bin/run-prod-migrations</code> to complete the steps outlined here.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="verify-input-files"></a>Verify Input Files<a class="hash-link" href="#verify-input-files" title="Direct link to heading">#</a></h2><p>Check that the files you are about to import have roughly the correct number of lines in them:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="tdl-scores"></a>TDL Scores<a class="hash-link" href="#tdl-scores" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">496592   TDL Scores - 1Aug2018 PP - NP - Code 2.csv</span></span><span class="token-line" style="color:#393A34"><span class="token plain">496592   TDL Scores - 1Aug2018 PP - PK - Code 2.csv</span></span><span class="token-line" style="color:#393A34"><span class="token plain">565673   TDL Scores - 1Aug2018 PP - NP - Code D.csv</span></span><span class="token-line" style="color:#393A34"><span class="token plain">565673   TDL Scores - 1Aug2018 PP - PK - Code D.csv</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="tsp-rates"></a>TSP Rates<a class="hash-link" href="#tsp-rates" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">496593   2018 Code 2 NonPeak Rates.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">496593   2018 Code 2 Peak Rates.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">565674   2018 Code D NonPeak Rates.txt</span></span><span class="token-line" style="color:#393A34"><span class="token plain">565674   2018 Code D Peak Rates.txt</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="tdl-performance-dates-vs-tsp-rate-dates"></a>TDL Performance Dates vs TSP Rate Dates<a class="hash-link" href="#tdl-performance-dates-vs-tsp-rate-dates" title="Direct link to heading">#</a></h3><p>Note that Rates overlap Performance Periods. You may get a new set of TDLs and will have to use existing (Non)Peak Rates.
E.g., To load the performance data for <code>Performance Period 1</code> 2019 the 2018 <code>* NonPeak Rates.txt</code> files were used.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Rate Cycle:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Peak: 5/15 to 9/30</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Performance Periods</span></span><span class="token-line" style="color:#393A34"><span class="token plain">1: 1/1   to  5/14</span></span><span class="token-line" style="color:#393A34"><span class="token plain">2: 5/15  to  7/31</span></span><span class="token-line" style="color:#393A34"><span class="token plain">3: 8/1   to  9/30</span></span><span class="token-line" style="color:#393A34"><span class="token plain">4: 10/1  to  12/31</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------------------------------------------------------------------------------+-----------------------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| 2018                                                                                       | 2019                        |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------------------------------------------------------------------------------------+-----------------------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Rate Cycle Rate - Non Peak (2017)     | Rate Cycle Rate - Peak (2018)    | Rate Cycle Rate - Non Peak (2018)          |  |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------------------------------+----------------------------------+--------------------------------------------+--+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Perf Period 1                         | Perf Period 2    | Perf Period 3 | Perf Period 4   | Perf Period 1            |  |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+------------------------------------------+---------------+---------------+-----------------+-----------------------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Jan    | Feb    | Mar    | Apr    | May  | Jun   | Jul   | Aug   | Sept  | Oct | Nov | Dec | Jan | Feb | Mar | Apr | May |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------+--------+--------+--------+------+-------+-------+-------+-------+-----+-----+-----+-----+-----+-----+-----+-----+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="load-tsp-discount-rates"></a>Load TSP Discount Rates<a class="hash-link" href="#load-tsp-discount-rates" title="Direct link to heading">#</a></h2><blockquote><p>If this isn&#x27;t your first time at the data-loading rodeo today:
<code>DROP TABLE IF EXISTS temp_tsp_discount_rates;</code></p></blockquote><p>Create a table to hold the incoming data:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE temp_tsp_discount_rates (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rate_cycle text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  origin text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  destination text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cos text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  scac text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  lh_rate numeric(6,2),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sit_rate numeric(6,2)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The files you need now will include the linehaul and SIT discounts and may have a name like <code>2018 Code 2 Peak Rates.txt</code>. The &quot;rates&quot; part is what you&#x27;re looking for: key columns are LH_RATE and SIT_RATE.</p><p>You will need to import <strong>two</strong> files, one for each code of service in the part of the rate cycle that applies to the TDL data you just imported.</p><ul><li>If your TDL data is during the peak part of the rate cycle (May 15th - September 30th), import the <strong>peak</strong> rates.</li><li>Otherwise, import the <strong>nonpeak</strong> rates.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">\copy temp_tsp_discount_rates </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/add/filename/for/discount/rates/2018 Code D Peak Rates.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">\copy temp_tsp_discount_rates </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/add/filename/for/discount/rates/2018 Code 2 Peak Rates.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="load-tsp-best-value-scores-from-tdl-data"></a>Load TSP Best Value Scores from TDL data<a class="hash-link" href="#load-tsp-best-value-scores-from-tdl-data" title="Direct link to heading">#</a></h2><p>Now, let&#x27;s get those best value scores. This file will likely have &quot;TDL scores&quot; in the title. Key columns are RANK and BVS.</p><blockquote><p>In case you already made this table...
<code>DROP TABLE IF EXISTS temp_tdl_scores;</code></p></blockquote><p>Duplicate the format of TDL scores CSVs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE temp_tdl_scores (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  market text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  origin text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  destination text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cos text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  quartile int,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rank int,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  scac text,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  svy_score numeric(8,4),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  rate_score numeric(8,4),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  bvs numeric(8,4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Use the <code>\copy</code> command in psql again to import the TDL scores. Again, you&#x27;ll need to import <strong>two</strong> files based on whether the dates you are working with are in the peak or nonpeak season. Use your absolute path for where you stored those CSV files.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">\copy temp_tdl_scores </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/add/filename/for/tdl/scores/TDL Scores - 1Aug2018 PP - PK - Code D.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">\copy temp_tdl_scores </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/add/filename/for/tdl/scores/TDL Scores - 1Aug2018 PP - PK - Code 2.csv&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> CSV HEADER</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="combining-scores-and-discounts"></a>Combining Scores and Discounts<a class="hash-link" href="#combining-scores-and-discounts" title="Direct link to heading">#</a></h2><p>Now let&#x27;s combine the important parts of both data sources into one table, which we&#x27;ll begin to shape into a full set of TSPP data.</p><p>The following command will create and populate the table described above with the relevant, overlapping details from the table imported earlier with BVSes and the table with discount rates:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE tdl_scores_and_discounts AS</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  SELECT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.market, s.origin, s.destination, s.cos, s.scac, s.bvs, dr.lh_rate, dr.sit_rate FROM temp_tdl_scores AS s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  LEFT JOIN</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    temp_tsp_discount_rates as dr</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.origin = dr.origin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.destination = dr.destination</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.cos = dr.cos</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    s.scac = dr.scac;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="add-column-to-hold-tdl-ids"></a>Add column to hold TDL IDs<a class="hash-link" href="#add-column-to-hold-tdl-ids" title="Direct link to heading">#</a></h3><p>Add a TDL ID column to fill with this next update:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> tdl_id uuid</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Sometimes the data provided to us represents fields (destination, most recently) in different ways. Here&#x27;s how to alter the destination column to match other data sources (most notably the TDL table) - to change &#x27;REGION 1&#x27; to just &#x27;1&#x27; to make the next step work:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">UPDATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl_scores_and_discounts</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  destination = RIGHT(destination, char_length(destination) - 7);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Add TDL IDs to the rows in our interim table:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">UPDATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl_scores_and_discounts as tsd</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl_id = tdl.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  traffic_distribution_lists as tdl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl.source_rate_area = tsd.origin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl.destination_region = tsd.destination</span></span><span class="token-line" style="color:#393A34"><span class="token plain">AND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl.code_of_service = tsd.cos;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Check for null TDL IDs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">DISTINCT</span><span class="token plain"> scac</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tdl_id </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="if-tdl-id-is-still-null"></a>If TDL ID is still null<a class="hash-link" href="#if-tdl-id-is-still-null" title="Direct link to heading">#</a></h4><p>If count returns anything but 0, you&#x27;ll need to add new TDL entries.
Check for new entries on the
<a href="https://move.mil/sites/default/files/2019-01/2019%20Domestic%20Channel%20Control%20List.pdf" target="_blank" rel="noopener noreferrer">Domestic Channel Control List</a>.
They&#x27;ll be highlighted in red.
Create a new temp table for TDLs and add the new entries as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> temp_tdls </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> traffic_distribution_lists</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> temp_tdls </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> temp_tdls </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> source_rate_area</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> destination_region</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code_of_service</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updated_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;D&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* ... */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uuid_generate_v4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;US4965500&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;10&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will add the new entries to the temporary TDL table,
forcing them to adhere to any table constraints
and generating new UUIDs to be consistent across environments.
For info on why having consistent UUIDs is important [[see this document|create-or-deactivate-users]]</p><p>We&#x27;ll now [[create a new migration|migrate-the-database.md#how-to-migrate-the-database]] with that data (replace your migration filename):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> bin/milmove</span></span><span class="token-line" style="color:#393A34"><span class="token plain">milmove gen migration -n add_new_tdls</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;INSERT INTO traffic_distribution_lists (id, source_rate_area, destination_region, code_of_service, created_at, updated_at) </span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">VALUES</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">$(</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">./scripts/psql-dev &quot;</span><span class="token string entity" style="color:#36acaa">\c</span><span class="token string" style="color:#e3116c">opy (SELECT id, source_rate_area, destination_region, code_of_service FROM temp_tdls WHERE import = true) TO stdout WITH (FORMAT CSV, FORCE_QUOTE *, QUOTE &#x27;&#x27;&#x27;&#x27;);&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">awk</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{print &quot;  (&quot;</span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c">&quot;, now(), now()),&quot;}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$ s/.$//&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> migrations/20190410152949_add_new_tdls.up.sql</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will copy all rows from the table that were included in the new TDL import
and create an insert statement for the data.
You can also use <code>pg_dump</code> to generate this migration,
however replacing the timestamps with <code>now()</code> allows the environments
to have true <code>created_at</code> and <code>updated_at</code> timestamps.
Not your locally inserted time.</p><p>Once this migration is written, run it and rejoin the TDLs as above.</p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="add-column-to-hold-tsp-ids"></a>Add column to hold TSP IDs<a class="hash-link" href="#add-column-to-hold-tsp-ids" title="Direct link to heading">#</a></h3><p>Make room for TSP IDs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> tsp_id uuid</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Import the TSP IDs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">UPDATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl_scores_and_discounts as tsd</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SET</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tsp_id = tsp.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transportation_service_providers tsp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tsd.scac = tsp.standard_carrier_alpha_code;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Similar to TDLs,
there may be missing TSPs.
Currently, we&#x27;re not using any of this TSP data for production moves,
but we have to satisfy the foreign key constraints for the TSPP data.</p><p>Check for missing TSP IDs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">DISTINCT</span><span class="token plain"> scac</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tdl_scores_and_discounts </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tsp_id </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="if-tsp-id-is-still-null"></a>If TSP ID is still null<a class="hash-link" href="#if-tsp-id-is-still-null" title="Direct link to heading">#</a></h4><p>Note we use GENERATED_UUID4_VAL here to represent a generated UUID, read [[this doc|migrate-the-database#a-note-about-uuid_generate_v4]] for details.
If this is not 0, add the TSPs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> temp_tsps </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> transportation_service_providers</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> temp_tsps </span><span class="token keyword" style="color:#00009f">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> temp_tsps </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">standard_carrier_alpha_code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISTINCT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scac</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> scac </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> standard_carrier_alpha_code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GENERATED_UUID4_VAL </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tdl_scores_and_discounts</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tsp_id </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><a href="/mymove-docs/docs/backend/database/migrate-the-database.md#how-to-migrate-the-database">Generate the migration</a> (replacing your migration filename):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> bin/milmove</span></span><span class="token-line" style="color:#393A34"><span class="token plain">milmove gen migration -n add_new_scacs</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;INSERT INTO transportation_service_providers (id, standard_carrier_alpha_code, created_at, updated_at) </span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">VALUES</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">$(</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">./scripts/psql-dev &quot;</span><span class="token string entity" style="color:#36acaa">\c</span><span class="token string" style="color:#e3116c">opy (SELECT id, standard_carrier_alpha_code FROM temp_tsps WHERE import = true) TO stdout WITH (FORMAT CSV, FORCE_QUOTE *, QUOTE &#x27;&#x27;&#x27;&#x27;);&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">awk</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{print &quot;  (&quot;</span><span class="token string variable" style="color:#36acaa">$0</span><span class="token string" style="color:#e3116c">&quot;, now(), now()),&quot;}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$ s/.$//&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> migrations/20190409010258_add_new_scacs.up.sql</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Run this migration and rejoin the TSP IDs as above.</p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="generate-data-for-production-import"></a>Generate data for production import<a class="hash-link" href="#generate-data-for-production-import" title="Direct link to heading">#</a></h3><p>Now we&#x27;re ready to combine the datasets together into one table. First, be sure to clear out the <code>transportation_service_provider_performances</code> table in case it already contains data:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> transportation_service_provider_performances</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following command will fill the TSPP table with data. Use your data&#x27;s current rate cycle and performance period date in lieu of the hard-coded dates below.</p><blockquote><p><em>Rate cycle</em> in this context means the rate cycle <strong>period</strong>, so either the peak or non-peak part of the annual rate cycle and <strong>not</strong> the rate cycle itself.</p><p><a href="https://docs.google.com/document/d/12AN1igDt9Acxm9cu1cJA0fiWQIMI3XGs5u_jhCHLo6I" target="_blank" rel="noopener noreferrer">This document</a> specifies the date ranges for both the performance periods and the rate cycle periods.</p></blockquote><p>Note we use GENERATED_UUID4_VAL here to represent a generated UUID, read [[this doc|migrate-the-database#a-note-about-uuid_generate_v4]] for details.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  transportation_service_provider_performances (id, performance_period_start, performance_period_end, traffic_distribution_list_id, offer_count, best_value_score, transportation_service_provider_id, created_at, updated_at, rate_cycle_start, rate_cycle_end, linehaul_rate, sit_rate)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  GENERATED_UUID4_VAL as id, &#x27;2018-08-01&#x27; as performance_period_start, &#x27;2018-09-30&#x27; as performance_period_end, tdl_id, 0 as offer_count, bvs, tsp_id, now() as created_at, now() as updated_at, &#x27;2018-05-15&#x27; as rate_cycle_start, &#x27;2018-09-30&#x27; as rate_cycle_end, lh_rate/100, sit_rate/100</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tdl_scores_and_discounts;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>/100</code> of the <code>sit_rate</code> and <code>linehaul_rate</code> columns accounts for the differences in representing percentages/decimals across sources. This changes integers into decimal representations that fit into our calculations of rates and reimbursements.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="export-tspp-data"></a>Export TSPP Data<a class="hash-link" href="#export-tspp-data" title="Direct link to heading">#</a></h3><p>Run this in your terminal to dump the contents of the <code>transportation_service_provider_performances</code> table for use elsewhere. Double-check your local db name before assuming this will work.</p><p><code>pg_dump -h localhost -U postgres -W dev_db --table transportation_service_provider_performances --data-only &gt; tspp_data_dump.pgsql</code></p><p>Et voilÃ : TSPPs!</p><p>Note that the above <code>pg_dump</code> command will generate a file that uses a single <code>COPY ... FROM stdin</code> to load data
as opposed to a series of <code>INSERT</code> statements.  Using <code>COPY</code> can be dramatically faster than <code>INSERT</code> -- around 100 times
faster in some cases.  We generally <a href="https://github.com/transcom/mymove/pull/2670/files#r322981353" target="_blank" rel="noopener noreferrer">prefer <code>INSERT</code></a>
but the amount of data being loaded may make using it simply too expensive for a migration.</p><p><strong>WARNING:</strong> If the generated file is larger than 250 MB then you will not be able to upload the file. This size limit is in place so that the anti-virus software can scan the file. In the case where a file has been generated that is larger than this size you&#x27;ll need to split the migration file into multiple migration files each with a size smaller than 250 MB.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="data-validation"></a>Data Validation<a class="hash-link" href="#data-validation" title="Direct link to heading">#</a></h2><p>The following SQL statements can be used to verify that the above process has been completed successfully. Some numbers may be slightly off
due to natural changes in the data, but any large discrepancies are a potential signal that something has gone wrong somewhere along the way.</p><p>NOTE: As of the updates for 2019-10-01 we only import the BVSes for the top performer, instead of everyone. This could lead to more variation in the numbers than in past updates. The numbers below have been updated to reflect the reduced imports.</p><p>NOTE 2: The first results below are what is expected after running the above import process. The subsequent results are from running the same verification queries after running all the migrations.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><pre tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* returns total count of performances during import process this matches rows in csv */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# SELECT COUNT(id) FROM transportation_service_provider_performances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- import process result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 847</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 19239</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all prod migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 5989085</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/* returns the lowest score and highest score */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# select min(best_value_score), max(best_value_score) from transportation_service_provider_performances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- import process result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   min   |  max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+--------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  91.0   | 100.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   min   |  max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">---------+--------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  50.0   | 100.0</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/* returns the lowest score and highest sit rate */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# select min(sit_rate), max(sit_rate) from transportation_service_provider_performances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  min | max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">------+------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0.45 | 0.63</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/* returns the lowest score and highest linehaul rate */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# select min(linehaul_rate), max(linehaul_rate) from transportation_service_provider_performances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> min | max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----+------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0.4 | 0.68</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/* returns the minimum and maximum number of areas a single tsp has won, so below means at min a tsp has 1, and at most a tsp has 511 */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# SELECT min(count), max(count) FROM (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECT transportation_service_provider_id, COUNT(id) FROM transportation_service_provider_performances</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    GROUP BY transportation_service_provider_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) as tspp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- import process result</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> min | max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----+------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   1 | 511</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> min | max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----+------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   1 | 2838</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all prod migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> min | max</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----+------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   2 | 8968</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/* returns the total number of TSPs */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_db=# SELECT count(DISTINCT transportation_service_provider_id) FROM transportation_service_provider_performances;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- import process result</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   35</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  907</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all prod migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> count</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  910</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(1 row)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT CONCAT(((bucket -1) * 100)::text, &#x27;-&#x27;, (bucket * 100)::text) as rows, count(transportation_service_provider_id) as tsps FROM (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECT transportation_service_provider_id, width_bucket(COUNT(id), 0, 2000, 20) as bucket FROM transportation_service_provider_performances</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    GROUP BY transportation_service_provider_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) as tspp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   GROUP BY bucket;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- import process result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   rows    | tsps</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------+-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0-100     |   33</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 200-300   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 500-600   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(3 rows)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   rows    | tsps</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------+-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0-100     |  898</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 100-200   |    3</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 200-300   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 400-500   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300-400   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 500-600   |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 1700-1800 |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 2000-2100 |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(8 rows)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- result after running all prod migrations</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   rows    | tsps</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------+-------</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 0-100     |   53</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 100-200   |    9</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 200-300   |   33</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 300-400   |   38</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 400-500   |    8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 500-600   |    7</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 600-700   |    3</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 700-800   |    3</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 800-900   |    2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 1100-1200 |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 1400-1500 |    1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 1500-1600 |    2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> 2000-2100 |  750</span></span><span class="token-line" style="color:#393A34"><span class="token plain">(13 rows)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Spot check the data by picking a row from the TDL and TSP text/CSV files and verifying the data:</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT source_rate_area, destination_region, code_of_service, performance_period_start, performance_period_end,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       best_value_score, rate_cycle_start, rate_cycle_end, linehaul_rate, sit_rate, standard_carrier_alpha_code,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       tdl.created_at</span></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM traffic_distribution_lists AS tdl</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LEFT JOIN transportation_service_provider_performances on tdl.id = transportation_service_provider_performances.traffic_distribution_list_id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">LEFT JOIN transportation_service_providers on transportation_service_provider_performances.transportation_service_provider_id = transportation_service_providers.id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE performance_period_start=&#x27;2019-10-01&#x27; and performance_period_end=&#x27;2019-12-31&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AND destination_region=&#x27;1&#x27; AND source_rate_area=&#x27;US11&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  AND code_of_service=&#x27;D&#x27;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="temp-data-clean-up"></a>Temp Data Clean Up<a class="hash-link" href="#temp-data-clean-up" title="Direct link to heading">#</a></h2><p>Vacuum up now that the party&#x27;s over. Only required if you haven&#x27;t reset the local database already.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE tdl_scores_and_discounts;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE temp_tdl_scores;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DROP TABLE temp_tsp_discount_rates;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="create-secure-migrations"></a>Create Secure Migrations<a class="hash-link" href="#create-secure-migrations" title="Direct link to heading">#</a></h2><p>You will have to create a secure migration for this data import. Two files will need to be created,
the file that contains the real data and a local secure migration (dummy file for dev). Follow the
[[secure migration steps|migrate-the-database#secure-migrations]].</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="how-to-create-the-dummy-file"></a>How to create the dummy file<a class="hash-link" href="#how-to-create-the-dummy-file" title="Direct link to heading">#</a></h3><p>You will need to scrub the data that is in the dummy file. The fields: <code>linehaul_rate</code>, <code>sit_rate</code>, and <code>best_value_score</code>
are company competition sensitive data and needs to scrubbed.</p><p>The file will also need to be reduced. Currently, we are picking 2 TSPs per TDL.</p><p>We have a <a href="/mymove-docs/docs/scripts/export-obfuscated-tspp-sample">script</a> to help with this process. The script will backup the TSPP table, make the appropriate reduction of
data and scrubbing of key columns, output the results, then restore the original TSPP table.  You can run it like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/export-obfuscated-tspp-sample &lt;filename&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Complete the [[secure migration steps|migrate-the-database#secure-migrations]] to
submit both migration files.</p></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/transcom/mymove-docs/edit/main/docs/backend/guides/tspp-data-creation.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mymove-docs/docs/backend/guides/golang-loops"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Loop Iteration in Golang</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mymove-docs/docs/backend/guides/use-optimistic-locking"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">What Is Optimistic Locking? Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#verify-input-files" class="table-of-contents__link">Verify Input Files</a><ul><li><a href="#tdl-scores" class="table-of-contents__link">TDL Scores</a></li><li><a href="#tsp-rates" class="table-of-contents__link">TSP Rates</a></li><li><a href="#tdl-performance-dates-vs-tsp-rate-dates" class="table-of-contents__link">TDL Performance Dates vs TSP Rate Dates</a></li></ul></li><li><a href="#load-tsp-discount-rates" class="table-of-contents__link">Load TSP Discount Rates</a></li><li><a href="#load-tsp-best-value-scores-from-tdl-data" class="table-of-contents__link">Load TSP Best Value Scores from TDL data</a></li><li><a href="#combining-scores-and-discounts" class="table-of-contents__link">Combining Scores and Discounts</a><ul><li><a href="#add-column-to-hold-tdl-ids" class="table-of-contents__link">Add column to hold TDL IDs</a></li><li><a href="#add-column-to-hold-tsp-ids" class="table-of-contents__link">Add column to hold TSP IDs</a></li><li><a href="#generate-data-for-production-import" class="table-of-contents__link">Generate data for production import</a></li><li><a href="#export-tspp-data" class="table-of-contents__link">Export TSPP Data</a></li></ul></li><li><a href="#data-validation" class="table-of-contents__link">Data Validation</a></li><li><a href="#temp-data-clean-up" class="table-of-contents__link">Temp Data Clean Up</a></li><li><a href="#create-secure-migrations" class="table-of-contents__link">Create Secure Migrations</a><ul><li><a href="#how-to-create-the-dummy-file" class="table-of-contents__link">How to create the dummy file</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/about">About</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tutorial">Docusaurus Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/frontend">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/backend">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/mymove-docs/docs/tools">Tools</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/transcom/mymove-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>MilMove Documentation GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/transcom/mymove" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>MilMove GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Docusaurus Official Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 United States Transportation Command. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mymove-docs/assets/js/runtime~main.05ef37e2.js"></script>
<script src="/mymove-docs/assets/js/main.8b649ace.js"></script>
</body>
</html>