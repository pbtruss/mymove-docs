"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[1451],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||o;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},68247:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return d}});var n=a(87462),r=a(63366),o=(a(67294),a(3905)),i=["components"],l={},s="How to Search for Application Errors",p={unversionedId:"vault/infra/search-for-application-errors",id:"vault/infra/search-for-application-errors",isDocsHomePage:!1,title:"How to Search for Application Errors",description:"Searching for errors from the application can be difficult.  Here is a playbook for finding specific errors.",source:"@site/docs/vault/infra/search-for-application-errors.md",sourceDirName:"vault/infra",slug:"/vault/infra/search-for-application-errors",permalink:"/mymove-docs/docs/vault/infra/search-for-application-errors",editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/vault/infra/search-for-application-errors.md",tags:[],version:"current",frontMatter:{},sidebar:"vaultSidebar",previous:{title:"How To Run Against S3 & CDN Locally",permalink:"/mymove-docs/docs/vault/infra/run-against-s3-locally"},next:{title:"How to View ECS Service Logs",permalink:"/mymove-docs/docs/vault/infra/view-ecs-service-logs"}},c=[{value:"Video examples",id:"video-examples",children:[]},{value:"Tips",id:"tips",children:[]},{value:"Playbook",id:"playbook",children:[{value:"Tracking ALB Errors in S3",id:"tracking-alb-errors-in-s3",children:[]},{value:"More in depth scanning",id:"more-in-depth-scanning",children:[]},{value:"An alternate way to query alb logs is using Athena",id:"an-alternate-way-to-query-alb-logs-is-using-athena",children:[]},{value:"Tracing Application Errors in CloudWatch",id:"tracing-application-errors-in-cloudwatch",children:[]},{value:"Alternative Method for Tracing Application Errors in CloudWatch",id:"alternative-method-for-tracing-application-errors-in-cloudwatch",children:[]},{value:"Tracking down users in Staging",id:"tracking-down-users-in-staging",children:[]}]}],u={toc:c};function d(e){var t=e.components,a=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-search-for-application-errors"},"How to Search for Application Errors"),(0,o.kt)("p",null,"Searching for errors from the application can be difficult.  Here is a playbook for finding specific errors."),(0,o.kt)("h2",{id:"video-examples"},"Video examples"),(0,o.kt)("p",null,"A couple of videos walking through the process of searching alb and application logs"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://zoom.us/rec/share/7u5yIuDO02xOWYHuzWz5Zpw4EYH4X6a81XBNr_EPxBw4iI9Ojy7W0SYGJM9lSdQD"},"Video walking through finding application errors 2020-01-08")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://zoom.us/recording/play/2DGo7KYqrvSAYvvEo2--zG_xx93K0ALUMLHJVXJl0X9WRo0lxkXXLAxp8IPHHDA8"},"A video of searching ALB errors"),"\nto see how this is done in real time. ",(0,o.kt)("strong",{parentName:"li"},"This Video is older and parts maybe out of date"))),(0,o.kt)("h2",{id:"tips"},"Tips"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Always check the timezone of the log messages. Messages from AWS infrastructure are in UTC whereas log messages\nfrom the app may be in PST.")),(0,o.kt)("h2",{id:"playbook"},"Playbook"),(0,o.kt)("h3",{id:"tracking-alb-errors-in-s3"},"Tracking ALB Errors in S3"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE:")," ALB logs are only stored in AWS S3. You can search them by downloading them locally and searching via the\ncommand line with the tools below or by using AWS Athena in the AWS Console."),(0,o.kt)("p",null,"Often we'll see 500 errors from the application that trigger the ",(0,o.kt)("inlineCode",{parentName:"p"},"alb-staging-target-5xx-limit")," alarm on the ALB.\nThe text is not super helpful:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-txt"},"Alarm Name\nalb-staging-target-5xx-limit\nAlarm Description\nTarget(s) behind ALB in staging are returning 5xx error codes.\nAlarm reason\nThreshold Crossed: 1 datapoint [2.0 (07/01/19 19:39:00)] was greater than or equal to the threshold (2.0).\nOld State\nOK\nCurrent State\nALARM\nLink to Alarm\nhttps://console.aws.amazon.com/cloudwatch/home?region=us-west-2#alarm:alarmFilter=ANY;name=alb-staging-target-5xx-limit\n")),(0,o.kt)("p",null,"A simple way to scan the logs is to use a helpful script we've built:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"../scripts/scan-alb-logs staging 500 2019/01/09,2019/01/10\n")),(0,o.kt)("p",null,"You can be more specific with particular domains:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"../scripts/scan-alb-logs staging 500 2019/01/09,2019/01/10 office.move.mil\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE:")," You cannot specify date ranges! You must specify each individual date."),(0,o.kt)("h3",{id:"more-in-depth-scanning"},"More in depth scanning"),(0,o.kt)("p",null,"If you want more control over the results you can continue here OR you can move on to the next section about understanding\nALB log entries."),(0,o.kt)("p",null,"You can download ALB logs for a specific date by using our ",(0,o.kt)("inlineCode",{parentName:"p"},"download-alb-logs")," command line tool with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"../scripts/download-alb-logs tmp prod 2019/01/09,2019/01/10\n")),(0,o.kt)("p",null,"Alternatively, you can run the ",(0,o.kt)("inlineCode",{parentName:"p"},"sync")," commands manually as:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"mkdir -p tmp/\naws s3 sync s3://transcom-ppp-aws-logs/alb/app-staging/AWSLogs/923914045601/elasticloadbalancing/us-west-2/2019/01/09/ ./tmp/\naws s3 sync s3://transcom-ppp-aws-logs/alb/app-staging/AWSLogs/923914045601/elasticloadbalancing/us-west-2/2019/01/10/ ./tmp/\n")),(0,o.kt)("p",null,"Then search for the errors in the ALB logs using ",(0,o.kt)("inlineCode",{parentName:"p"},"big-cat"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"gunzip"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"read-alb-logs"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"jq"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'make build_tools\nexport http_code=500\nbig-cat \'./tmp/*.log.gz\' | gunzip | read-alb-logs | jq ". | select( .elbStatusCode | startswith(\\"${http_code}\\")) | {timestamp, clientPort, elbStatusCode, targetStatusCode, request, actionsExecuted}"\n')),(0,o.kt)("p",null,"And you'll see events like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'{\n  "timestamp": "2019-06-04T16:49:53.728140Z",\n  "clientPort": "193.232.106.88:47233",\n  "elbStatusCode": "403",\n  "targetStatusCode": "-",\n  "request": "GET https://54.201.161.247:443/.env HTTP/1.1",\n  "actionsExecuted": "waf"\n}\n{\n  "timestamp": "2019-06-04T17:13:30.820491Z",\n  "clientPort": "180.248.30.194:57707",\n  "elbStatusCode": "403",\n  "targetStatusCode": "-",\n  "request": "GET http://54.201.161.247:80/ HTTP/1.1",\n  "actionsExecuted": "waf"\n}\n')),(0,o.kt)("p",null,"You can use any ",(0,o.kt)("inlineCode",{parentName:"p"},"jq")," filter you want on the output data like filtering on timestamp."),(0,o.kt)("h3",{id:"an-alternate-way-to-query-alb-logs-is-using-athena"},"An alternate way to query alb logs is using Athena"),(0,o.kt)("p",null,"To query using Athena follow these steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Navigate to ",(0,o.kt)("a",{parentName:"li",href:"https://us-west-2.console.aws.amazon.com/athena/home?region=us-west-2#query/history/e6bbe351-39ae-415d-9bfa-b3c00b9b8fb4"},"Athena")),(0,o.kt)("li",{parentName:"ol"},"Make sure you have selected the correct database, for prod you should have selected ",(0,o.kt)("inlineCode",{parentName:"li"},"prod_alb_logs")),(0,o.kt)("li",{parentName:"ol"},"Run the folloeing query to narrow down the records, make sure you update year and month for faster/cheaper response.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT type,\n         elb_status_code,\n         actions_executed,\n         *,\n         from_iso8601_timestamp(time) AS timestmp\nFROM "alb_logs"\nWHERE elb_status_code > 499\nAND year = 2020\nAND month = 5\nORDER BY  timestmp DESC limit 50\n')),(0,o.kt)("h4",{id:"understanding-alb-log-entries"},"Understanding ALB Log Entries"),(0,o.kt)("p",null,"References:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html"},"AWS ALB Log Entries"))),(0,o.kt)("p",null,"There are two forms of ",(0,o.kt)("inlineCode",{parentName:"p"},"elb_status_code target_status_code")," that you'll see on a log line, ",(0,o.kt)("inlineCode",{parentName:"p"},"200 200")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"301 -"),". The first\nis the ELB status code, which is what the user sees.  The second is the Target status code, which is what the application\ncontainer is returning. If the Target status code is ",(0,o.kt)("inlineCode",{parentName:"p"},"-")," that means that the ALB did not forward the traffic from the\nuser to the application container or the application container failed to respond."),(0,o.kt)("p",null,"The most common reason you're looking at these logs is to debug 5XX errors. Here is a short key for things you'll see:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Code"),(0,o.kt)("th",{parentName:"tr",align:null},"Common meaning"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"500"),(0,o.kt)("td",{parentName:"tr",align:null},"The application is returning a 500 from an unhandled error.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"501"),(0,o.kt)("td",{parentName:"tr",align:null},"The ALB returns a 501 when it receives an ",(0,o.kt)("a",{parentName:"td",href:"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-troubleshooting.html#http-501-issues"},"unsupported Transfer-Encoding header"),", e.g, ",(0,o.kt)("inlineCode",{parentName:"td"},"Transfer-Encoding: defalate"),".")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"502"),(0,o.kt)("td",{parentName:"tr",align:null},"The container was recycled because the ALB told ECS that the container was unhealthy.")))),(0,o.kt)("p",null,"You can manually generate a 501 error with a deflate encoding: ",(0,o.kt)("inlineCode",{parentName:"p"},'curl -v -X POST --http1.1 -H "Transfer-Encoding: deflate" https://example.com'),"."),(0,o.kt)("p",null,"Its rare but sometimes the WAF has problems. You can check the ",(0,o.kt)("inlineCode",{parentName:"p"},"actions_executed")," field in the ALB log to find out\nwhat has happened. Normal traffic actions are ",(0,o.kt)("inlineCode",{parentName:"p"},"waf,forward"),", which indicates the WAF analyzed the request and forwarded it to the container. If traffic was blocked by the WAF, you'll just see ",(0,o.kt)("inlineCode",{parentName:"p"},"waf"),".  If the WAF itself had problems (which happens very rarely), you'll see ",(0,o.kt)("inlineCode",{parentName:"p"},"waf-failed"),"."),(0,o.kt)("h3",{id:"tracing-application-errors-in-cloudwatch"},"Tracing Application Errors in CloudWatch"),(0,o.kt)("p",null,"After finding the ALB error messages the next best thing to do is to open up CloudWatch Logs and look into either\n",(0,o.kt)("inlineCode",{parentName:"p"},"ecs-tasks-app-<environment>")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"ecs-tasks-app-client-tls-<environment>"),".  As an example you can look into the logs\nfor Staging here:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://console.amazonaws-us-gov.com/cloudwatch/home?region=us-gov-west-1#logStream:group=ecs-tasks-app-stg"},"ecs-tasks-app-stg log streams")),(0,o.kt)("p",null,"It's worth noting that each container running in Fargate creates a unique Log Stream. That means you'll have to\nlook through several log streams to find the events corresponding to the alarm.  The best way to do this is to\nmatch up the ",(0,o.kt)("inlineCode",{parentName:"p"},"Last Event Time")," with the time listed in the ALB alarm."),(0,o.kt)("p",null,"Open up the log stream and search for ",(0,o.kt)("inlineCode",{parentName:"p"},"{ $.resp-status > 499 }")," in the search bar.  Here's an example:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#logEventViewer:group=ecs-tasks-app-staging;stream=app/app-staging/c0fce04c-d248-4e90-b7c0-a4a5db187c68;filter=%7B%20$.resp-status%20%3E%20499%20%7D;start=2019-01-06T20:40:04Z"},"errors in log stream")),(0,o.kt)("p",null,"You can glean a couple useful pieces of information from the log message.  Look especially at these items if they exist:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"git-commit"),(0,o.kt)("li",{parentName:"ul"},"host"),(0,o.kt)("li",{parentName:"ul"},"url"),(0,o.kt)("li",{parentName:"ul"},"user-id"),(0,o.kt)("li",{parentName:"ul"},"service-member-id"),(0,o.kt)("li",{parentName:"ul"},"office-user-id"),(0,o.kt)("li",{parentName:"ul"},"admin-user-id")),(0,o.kt)("p",null,"Most logged error messages come after the log lines that have useful information.  The best way to find those lines is to limit the log stream to a period of time that surrounds the error message you're looking at."),(0,o.kt)("p",null,"With the URL route and the user information you can usually track down the piece of code that is causing the issue."),(0,o.kt)("h3",{id:"alternative-method-for-tracing-application-errors-in-cloudwatch"},"Alternative Method for Tracing Application Errors in CloudWatch"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Navigate to ",(0,o.kt)("a",{parentName:"li",href:"https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#logs-insights:queryDetail=~(end~'2020-05-16T03*3a59*3a59.999Z~start~'2020-05-15T04*3a00*3a00.000Z~timeType~'ABSOLUTE~tz~'Local~editorString~'fields*20*40timestamp*2c*20*40message*2c*20url*2c*20*60resp-status*60*0a*7c*20sort*20*40timestamp*20desc*0a*7c*20filter*20*60x-forwarded-for*60*20*3d*20*2298.150.90.145*22*0a*7c*20limit*202000~isLiveTail~false~queryId~'48b8513b-b1a3-447b-a5cd-4ee0a3f65739~source~(~'ecs-tasks-app-prod))"},"cloudwatch insights")),(0,o.kt)("li",{parentName:"ol"},"Make sure you have the correct log stream selected, for production environment you should have:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ecs-task-app-prod\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Run a query to narrow down records, the following query can be useful ")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'fields @timestamp, @message, url\n| sort @timestamp desc\n| filter `x-forwarded-for` = "98.150.90.145"\n| limit 2000\n')),(0,o.kt)("h3",{id:"tracking-down-users-in-staging"},"Tracking down users in Staging"),(0,o.kt)("p",null,"If you have the ",(0,o.kt)("inlineCode",{parentName:"p"},"office-user-id")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"admin-user-id")," you can run ",(0,o.kt)("inlineCode",{parentName:"p"},"make run_prod_migrations")," to download the secret\nprod migrations locally and match the users."))}d.isMDXComponent=!0}}]);