"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[6259],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=o,h=p["".concat(l,".").concat(m)]||p[m]||u[m]||r;return n?a.createElement(h,i(i({ref:t},d),{},{components:n})):a.createElement(h,i({ref:t},d))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7810:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return d},default:function(){return p}});var a=n(7462),o=n(3366),r=(n(7294),n(3905)),i=["components"],s={},l="How To Create An ECS Scheduled Task",c={unversionedId:"old-wiki/create-an-ecs-scheduled-task",id:"old-wiki/create-an-ecs-scheduled-task",isDocsHomePage:!1,title:"How To Create An ECS Scheduled Task",description:"An ECS Scheduled Task is similar to a cron job. It runs a docker container inside our ECS Cluster in AWS on a",source:"@site/docs/old-wiki/create-an-ecs-scheduled-task.md",sourceDirName:"old-wiki",slug:"/old-wiki/create-an-ecs-scheduled-task",permalink:"/docs/old-wiki/create-an-ecs-scheduled-task",editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/old-wiki/create-an-ecs-scheduled-task.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to Automatically add JIRA ID to Commit Message",permalink:"/docs/old-wiki/automatically-add-jira-id-to-commit-message"},next:{title:"How To Create or Deactivate Users",permalink:"/docs/old-wiki/create-or-deactivate-users"}},d=[{value:"Writing the Function",id:"writing-the-function",children:[]},{value:"Test the code locally",id:"test-the-code-locally",children:[{value:"AWS IAM Permissions",id:"aws-iam-permissions",children:[]},{value:"AWS Resource Throttling",id:"aws-resource-throttling",children:[]}]},{value:"Updating CircleCI to Deploy",id:"updating-circleci-to-deploy",children:[]},{value:"Viewing logs",id:"viewing-logs",children:[]}],u={toc:d};function p(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-to-create-an-ecs-scheduled-task"},"How To Create An ECS Scheduled Task"),(0,r.kt)("p",null,"An ECS Scheduled Task is similar to a cron job. It runs a docker container inside our ECS Cluster in AWS on a\nschedule defined by an CloudWatch Rule (typically a cron rule). These tasks can do things like update the DB on a\nregular schedule or send out emails."),(0,r.kt)("h2",{id:"writing-the-function"},"Writing the Function"),(0,r.kt)("p",null,"You will need to start out by writing a new function to do the task locally. The code for this function\nshould go into the ",(0,r.kt)("inlineCode",{parentName:"p"},"cmd/milmove-tasks/")," directory and be named similar to the command that will kick off your\nscheduled task. For instance ",(0,r.kt)("inlineCode",{parentName:"p"},"save_fuel_price_data.go")," is the code for running the ECS Scheduled Task for\nsaving fuel price data. You integrate this code into the ",(0,r.kt)("inlineCode",{parentName:"p"},"cmd/milmove-tasks/main.go")," file using the\n",(0,r.kt)("a",{parentName:"p",href:"github.com/spf13/cobra"},"spf13/cobra")," library as a sub command. Once the binary has been compiled with\n",(0,r.kt)("inlineCode",{parentName:"p"},"make bin/milmove-tasks")," your command should be runnable by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"bin/milmove-tasks save-fuel-price-data")," or\nsimilar based on the name you chose.  Since you're writing a sub-command the flags for that command will be\nunique to your command alone and should be contained withing your golang file."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WARNING:")," It is very important that your sub-command name is less than or equal to 25 characters. This same name\nis referenced by the CircleCI and AWS terraform code to provision your task. The name must be identical in all\ncases and names longer than 25 characters will throw errors when provisioning."),(0,r.kt)("h2",{id:"test-the-code-locally"},"Test the code locally"),(0,r.kt)("p",null,"You should be able to test the code locally either by running the code directly via ",(0,r.kt)("inlineCode",{parentName:"p"},"bin/milmove subcommand")," or\nvia the ",(0,r.kt)("inlineCode",{parentName:"p"},"Makefile")," targets you will need to create. In the file you should copy the target ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks_save_fuel_price_data"),"\nand make a similar target that matches your command in the section for ",(0,r.kt)("inlineCode",{parentName:"p"},"SCHEDULED TASK TARGETS")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Makefile"),".\nIt is important that you pass in only the environment variables (designated by ",(0,r.kt)("inlineCode",{parentName:"p"},"-e"),") that are needed for your task\nand no more. Be as specific as possible. Then when you invoke ",(0,r.kt)("inlineCode",{parentName:"p"},"make tasks_your_subcommand")," you should see the\n",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile.tasks_local")," file built and your command run.\nthat references your subcommand."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WARNING:")," It is CRITICAL that the subcommand name you used earlier matches the ",(0,r.kt)("inlineCode",{parentName:"p"},"task_name")," given to the module.\nIf the name doesn't match then you won't see the task work and the error messages you get will not be very helpful."),(0,r.kt)("p",null,"You will also want to write a cron job expression that matches how often you need to run the task. AWS has documentation\non ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions"},"Cron Expressions")," that\nyou should reference as it is slightly different than normal cron expressions on Unix."),(0,r.kt)("p",null,"Lastly the Infra team needs to give your scheduled task access to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/transcom/transcom-infrasec-com/blob/6e57f84b937376a1a5f4556869304ed81f453ef4/modules/aws-app-environment/main.tf#L213-L216"},"RDS IAM Role"),". This has to happen after the ECS task is provisioned due to some odd behavior\nof Terraform v0.11."),(0,r.kt)("p",null,"Your changes will now need to be deployed to all three environments: experimental, staging, and prod. This doesn't mean\nyour code will begin running as the tasks haven't been deployed by CircleCI at this point. That means its safe to provision\nall of the environments in advance."),(0,r.kt)("h3",{id:"aws-iam-permissions"},"AWS IAM Permissions"),(0,r.kt)("p",null,"The IAM Permissions for the task are managed in a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/transcom/transcom-infrasec-com/blob/6e57f84b937376a1a5f4556869304ed81f453ef4/modules/aws-app-environment/ecs-scheduled-task/main.tf#L149-L200"},"Task Role Policy"),".\nYou would modify the policy if there is an action that your task needs that isn't already available (like DB, S3, or\nSES access). If you need to modify these to enable use of a new AWS resource please work with Infrastructure to\nproperly scope the access to be as narrow as possible for your task's use case (ie no \"*\" resources if possible).\nThis is because your changes will be available to all the other tasks and may inadvertently give access to a resource\nthat another task shouldn't have access to.  When in doubt please work with Infrastructure."),(0,r.kt)("h3",{id:"aws-resource-throttling"},"AWS Resource Throttling"),(0,r.kt)("p",null,"Many of the resources in AWS have built-in throttling. For example you can only send up to 80 emails per second with\nSES. Your code needs to be aware of these throttling limits and take into account errors when throttling limits are\nhit. It's also important that you add logging to your code so it's easier to determine what went wrong in your code\nwhen working with AWS resources."),(0,r.kt)("h2",{id:"updating-circleci-to-deploy"},"Updating CircleCI to Deploy"),(0,r.kt)("p",null,"To deploy with CircleCI you need to modify the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/transcom/mymove/blob/d676b217ea67dfd893d770a77bb9e2d898d0b891/.circleci/config.yml#L89-L98"},"deploy_tasks_steps"),"\nin the ",(0,r.kt)("inlineCode",{parentName:"p"},".circleci/config.yml"),". Each scheduled task needs a separate ",(0,r.kt)("inlineCode",{parentName:"p"},"deploy:")," section in this step. The important\nparts to modify in the ",(0,r.kt)("inlineCode",{parentName:"p"},"deploy")," section ",(0,r.kt)("inlineCode",{parentName:"p"},"command")," argument is the flag ",(0,r.kt)("inlineCode",{parentName:"p"},"--command")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"--command-args"),". These are\nused by the ",(0,r.kt)("inlineCode",{parentName:"p"},"bin/ecs-deploy-task-container")," code to create a Task Definition in ECS that is similar to a Dockerfile\nwith ",(0,r.kt)("inlineCode",{parentName:"p"},"--command")," mapping to ",(0,r.kt)("inlineCode",{parentName:"p"},"entrypoint")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"--command-args")," mapping to ",(0,r.kt)("inlineCode",{parentName:"p"},"command")," in a Dockerfile."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note:")," You can deploy your code to the experimental environment to test things out at this point. It's suggested that\nyou update the ",(0,r.kt)("inlineCode",{parentName:"p"},"cron")," rule in terraform to run once per minute (if that doesn't break throttling thresholds) so that you\ncan more quickly see if your code is doing what is expected."),(0,r.kt)("p",null,"Finally merge your code with the ",(0,r.kt)("inlineCode",{parentName:"p"},"master")," branch and it will deploy in the regular manner of staging and then prod."),(0,r.kt)("h2",{id:"viewing-logs"},"Viewing logs"),(0,r.kt)("p",null,"Similar to the application all logs for ECS Scheduled Tasks will end up in AWS CloudWatch Logs.  For example,\nif you want to see the scheduled task logs in experimental you'd go to the ",(0,r.kt)("inlineCode",{parentName:"p"},"ecs-tasks-app-experimental")," Log Group\nand search for a log stream named after your subcommand. For instance, with ",(0,r.kt)("inlineCode",{parentName:"p"},"save-fuel-price-data")," the log stream is\nnamed ",(0,r.kt)("inlineCode",{parentName:"p"},"app-tasks/app-tasks-save-fuel-price-data-experimental/TASKID")," (where ",(0,r.kt)("inlineCode",{parentName:"p"},"TASKID")," is a random string that\ncorresponds to the task ID of the last run task). You can look at the ",(0,r.kt)("inlineCode",{parentName:"p"},"Last Event Time")," column to find the log\nstream you are looking for. Open up the log stream and look at your data."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WARNING:")," CloudWatch Insights is not super valuable for these kinds of logs. In general scheduled tasks run only\nonce per day or less and have very few log lines. If you use CloudWatch Insights you'll get logs across multiple\nlog streams and not necessarily in an order that makes sense for the execution of the task. Please avoid using\nCloudWatch Insights when debugging your task if you wish to save yourself a lot of pain."))}p.isMDXComponent=!0}}]);