"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[8480],{3905:function(t,e,n){n.d(e,{Zo:function(){return c},kt:function(){return p}});var a=n(67294);function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function r(t,e){if(null==t)return{};var n,a,i=function(t,e){if(null==t)return{};var n,a,i={},s=Object.keys(t);for(a=0;a<s.length;a++)n=s[a],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(a=0;a<s.length;a++)n=s[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var l=a.createContext({}),u=function(t){var e=a.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):o(o({},e),t)),n},c=function(t){var e=u(t.components);return a.createElement(l.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},h=a.forwardRef((function(t,e){var n=t.components,i=t.mdxType,s=t.originalType,l=t.parentName,c=r(t,["components","mdxType","originalType","parentName"]),h=u(n),p=i,m=h["".concat(l,".").concat(p)]||h[p]||d[p]||s;return n?a.createElement(m,o(o({ref:e},c),{},{components:n})):a.createElement(m,o({ref:e},c))}));function p(t,e){var n=arguments,i=e&&e.mdxType;if("string"==typeof t||i){var s=n.length,o=new Array(s);o[0]=h;var r={};for(var l in e)hasOwnProperty.call(e,l)&&(r[l]=e[l]);r.originalType=t,r.mdxType="string"==typeof t?t:i,o[1]=r;for(var u=2;u<s;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},24245:function(t,e,n){n.r(e),n.d(e,{frontMatter:function(){return r},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return c},default:function(){return h}});var a=n(87462),i=n(63366),s=(n(67294),n(3905)),o=["components"],r={sidebar_position:9},l="Running server tests inside a transaction",u={unversionedId:"backend/testing/running-server-tests-inside-a-transaction",id:"backend/testing/running-server-tests-inside-a-transaction",isDocsHomePage:!1,title:"Running server tests inside a transaction",description:"Background",source:"@site/docs/backend/testing/running-server-tests-inside-a-transaction.md",sourceDirName:"backend/testing",slug:"/backend/testing/running-server-tests-inside-a-transaction",permalink:"/mymove-docs/docs/backend/testing/running-server-tests-inside-a-transaction",editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/testing/running-server-tests-inside-a-transaction.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9},sidebar:"backendSidebar",previous:{title:"Interacting with the database in Go server tests",permalink:"/mymove-docs/docs/backend/testing/interacting-with-the-db-in-go-server-tests"},next:{title:"Test data generation",permalink:"/mymove-docs/docs/backend/testing/test-data-generation"}},c=[{value:"Background",id:"background",children:[]},{value:"How to convert a package to use transactions",id:"how-to-convert-a-package-to-use-transactions",children:[]},{value:"suite.Run vs suite.RunWithRollback",id:"suiterun-vs-suiterunwithrollback",children:[{value:"suite.Run",id:"suiterun",children:[]},{value:"suite.RunWithRollback",id:"suiterunwithrollback",children:[]}]},{value:"How to fix failing tests after turning on transactions",id:"how-to-fix-failing-tests-after-turning-on-transactions",children:[{value:"Why data setup has to be repeated within each subtest",id:"why-data-setup-has-to-be-repeated-within-each-subtest",children:[]}]},{value:"Updating/adding to existing tests that use transactions",id:"updatingadding-to-existing-tests-that-use-transactions",children:[]}],d={toc:c};function h(t){var e=t.components,n=(0,i.Z)(t,o);return(0,s.kt)("wrapper",(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"running-server-tests-inside-a-transaction"},"Running server tests inside a transaction"),(0,s.kt)("h2",{id:"background"},"Background"),(0,s.kt)("p",null,"In June 2021, we introduced the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/DATA-DOG/go-txdb"},"go-txdb")," tool to allow us to run tests within a transaction, and then roll back the transaction after the test. This allows each test to start with a clean DB state, and is much faster than truncating the DB, which is how we've been resetting the DB all this time. Here is the PR that introduced transactions in tests: ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/transcom/mymove/pull/6650"},"https://github.com/transcom/mymove/pull/6650")),(0,s.kt)("p",null,"The original PR was designed in a non-breaking way such that existing tests that still use truncation can continue to run. The idea was to make the transaction feature opt-in, and incrementally update each package to use transactions. The PR updated several packages to give examples of what it takes to start using transactions. Follow the steps below to convert more packages."),(0,s.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,s.kt)("div",{parentName:"div",className:"admonition-heading"},(0,s.kt)("h5",{parentName:"div"},(0,s.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,s.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,s.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"About running tests in code editor or IDE")),(0,s.kt)("div",{parentName:"div",className:"admonition-content"},(0,s.kt)("p",{parentName:"div"},"Before you start running tests in Goland or other editor, make sure to run ",(0,s.kt)("inlineCode",{parentName:"p"},"make\nserver_test_setup")," first."))),(0,s.kt)("h2",{id:"how-to-convert-a-package-to-use-transactions"},"How to convert a package to use transactions"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Go to your package's top-level ",(0,s.kt)("inlineCode",{parentName:"li"},"*_test.go")," file. It's the one that defines a ",(0,s.kt)("inlineCode",{parentName:"li"},"SetupTest()")," function. For example, for the ",(0,s.kt)("inlineCode",{parentName:"li"},"ghcapi")," package, the file is in ",(0,s.kt)("inlineCode",{parentName:"li"},"pkg/handlers/ghcapi/api_test.go"),"."),(0,s.kt)("li",{parentName:"ol"},"Remove any calls to ",(0,s.kt)("inlineCode",{parentName:"li"},"TruncateAll")," in the the ",(0,s.kt)("inlineCode",{parentName:"li"},"SetupTest()")," function. If that's the only thing in that function, you can remove ",(0,s.kt)("inlineCode",{parentName:"li"},"SetupTest()"),"."),(0,s.kt)("li",{parentName:"ol"},"Remove any calls to ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.TruncateAll()")," in the package's tests."),(0,s.kt)("li",{parentName:"ol"},"In the function that defines the test suite (it's usually the last function, and its name starts with ",(0,s.kt)("inlineCode",{parentName:"li"},"Test")," and ends with ",(0,s.kt)("inlineCode",{parentName:"li"},"Suite"),", such as ",(0,s.kt)("inlineCode",{parentName:"li"},"TestHandlerSuite"),"), add ",(0,s.kt)("inlineCode",{parentName:"li"},", testingsuite.WithPerTestTransaction()")," after ",(0,s.kt)("inlineCode",{parentName:"li"},"testingsuite.CurrentPackage()"),". For example:")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-golang"},'hs := &HandlerSuite{\n    BaseHandlerTestSuite: handlers.NewBaseHandlerTestSuite(\n        logger,\n        notifications.NewStubNotificationSender("adminlocal", logger),\n        testingsuite.CurrentPackage(),\n        testingsuite.WithPerTestTransaction(),\n    ),\n}\n')),(0,s.kt)("p",null,"Here's an ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/transcom/mymove/pull/6650/commits/ab1e72fbd559b73dc7a9089c0d5d5d12d4f83ba2"},"example commit that converts the ghcapi package"),"."),(0,s.kt)("ol",{start:4},(0,s.kt)("li",{parentName:"ol"},"Run the tests and see if any fail. If none fail, then you are done! If tests fail, read on to fix them.")),(0,s.kt)("h2",{id:"suiterun-vs-suiterunwithrollback"},"suite.Run vs suite.RunWithRollback"),(0,s.kt)("p",null,"We have two ways you can run tests, ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.RunWithRollback"),". Each has a use case, so you need to make sure you use the correct one."),(0,s.kt)("h3",{id:"suiterun"},"suite.Run"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"If the code you are testing is using transactions, this is the one you need to use.")),(0,s.kt)("h3",{id:"suiterunwithrollback"},"suite.RunWithRollback"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"This can only be used if per test transactions are turned on."),(0,s.kt)("li",{parentName:"ul"},"This will roll back changes after each test. This means you can reuse data that was set up in the main test in each of the subtests.")),(0,s.kt)("h2",{id:"how-to-fix-failing-tests-after-turning-on-transactions"},"How to fix failing tests after turning on transactions"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"If the tests are using ",(0,s.kt)("inlineCode",{parentName:"li"},'suite.T().Run("some test description", func(t *testing.T)'),", replace all instances of ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.T().Run")," with ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.RunWithRollback")," and all instances of ",(0,s.kt)("inlineCode",{parentName:"li"},"func(t *testing.T)")," with ",(0,s.kt)("inlineCode",{parentName:"li"},"func()"),". You'll also need to remove the ",(0,s.kt)("inlineCode",{parentName:"li"},"testing")," package from the ",(0,s.kt)("inlineCode",{parentName:"li"},"import")," statement.",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"If the tests fail, it's most likely because the code under test uses transactions. In this case, you'll want to use ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.Run"),", and in some cases, that's enough to get the tests to pass."),(0,s.kt)("li",{parentName:"ul"},"If not, it could be because each subtest is sharing DB setup. In that case, extract the shared setup into a separate function, and call that function at the beginning of each subtest. Look at the diff of ",(0,s.kt)("inlineCode",{parentName:"li"},"pkg/handlers/ghcapi/orders_test.go")," in ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/transcom/mymove/pull/6650/commits/ab1e72fbd559b73dc7a9089c0d5d5d12d4f83ba2"},"this example"),"."),(0,s.kt)("li",{parentName:"ul"},"If the shared setup was already in a separate function, it should just be a matter of calling the setup function at the beginning of each subtest. ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/transcom/mymove/pull/6650/commits/dc6d5805a104d10463a7fd5382d43a598b6626a8"},"Here's an example"),"."))),(0,s.kt)("li",{parentName:"ul"},"Remove any calls to ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.TruncateAll()")," in the tests. Here's an example of ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/transcom/mymove/pull/6650/commits/ecefc78ef874644f9191d3a70aacb573bed63567"},"how the models tests were converted to use transactions"),"."),(0,s.kt)("li",{parentName:"ul"},"Replace ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.T().Fatalf")," with ",(0,s.kt)("inlineCode",{parentName:"li"},"suite.Fail"))),(0,s.kt)("p",null,"In a few cases, running inside transactions have exposed that the tests were not actually running in isolation from each other and so the test wasn't actually testing what it thought it was. In those cases you may find latent bugs that need to be fixed or tests that need to be rethought so they really test the right thing."),(0,s.kt)("h3",{id:"why-data-setup-has-to-be-repeated-within-each-subtest"},"Why data setup has to be repeated within each subtest"),(0,s.kt)("p",null,"In ",(0,s.kt)("inlineCode",{parentName:"p"},"pkg/testingsuite/pop_suite.go"),", we created our own ",(0,s.kt)("inlineCode",{parentName:"p"},"Run")," function that overrides the default testify ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run")," to ensure that the test DB is torn down for per-transaction tests."),(0,s.kt)("p",null,"It would be nice if subtests could start a new transaction inside\nthe current connection so they could reuse db setup between\nsubtests. Unfortunately, because ",(0,s.kt)("inlineCode",{parentName:"p"},"database/sql")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"pop")," do not\nsupport nested transactions, this gets complicated and hairy\nquickly. When testing that approach, connections wouldn't get\nclosed and cause other tests to hang or subtests would report\nincorrect errors about transactions already being closed."),(0,s.kt)("p",null,"And so, if per test transaction is enabled, each subtest gets a new\nconnection. This means subtests are really just like main tests,\nbut subtests are a helpful way to group tests together, which can\nbe useful. Therefore, shared setup has to be moved to a function that can be run once\nper subtest. In testing this approach, it was still faster with per test\ntransactions than the old way of cloning a DB per package."),(0,s.kt)("p",null,"In addition to the ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run")," function, we also have ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.RunWithRollback")," that could eliminate the need for calling the setup function within each subtest. This is the case if the code under test does not use transactions. If the code under test starts its own transaction, then ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run")," should be used."),(0,s.kt)("h2",{id:"updatingadding-to-existing-tests-that-use-transactions"},"Updating/adding to existing tests that use transactions"),(0,s.kt)("p",null,"Make a note of how the tests are set up, and follow the existing patterns, such as using ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.RunWithRollback"),", and calling the shared DB setup function within each new subtest you add, where applicable."),(0,s.kt)("p",null,"If you modify the code under test such that it now starts using transactions, and if the existing tests were using ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.RunWithRollback"),", you'll need to update the tests to use ",(0,s.kt)("inlineCode",{parentName:"p"},"suite.Run"),"."))}h.isMDXComponent=!0}}]);