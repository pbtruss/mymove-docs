"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[5849],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=d(n),m=i,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var d=2;d<r;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9762:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return c},default:function(){return u}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={},l="Anti-Virus",d={unversionedId:"old-wiki/anti_virus",id:"old-wiki/anti_virus",isDocsHomePage:!1,title:"Anti-Virus",description:"This document provides an overview of the anti-virus solutions employed by the MilMove project.",source:"@site/docs/old-wiki/anti_virus.md",sourceDirName:"old-wiki",slug:"/old-wiki/anti_virus",permalink:"/mymove-docs/docs/old-wiki/anti_virus",editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/old-wiki/anti_virus.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to Add Application Logging",permalink:"/mymove-docs/docs/old-wiki/add-application-logging"},next:{title:"How to Automatically add JIRA ID to Commit Message",permalink:"/mymove-docs/docs/old-wiki/automatically-add-jira-id-to-commit-message"}},c=[{value:"Source Code Scanning",id:"source-code-scanning",children:[{value:"Virus Findings",id:"virus-findings",children:[]},{value:"Troubleshooting",id:"troubleshooting",children:[]}]},{value:"Upload Object Scanning in AWS S3",id:"upload-object-scanning-in-aws-s3",children:[{value:"Development",id:"development",children:[]},{value:"Object Tagging",id:"object-tagging",children:[]},{value:"Scanned buckets",id:"scanned-buckets",children:[]}]}],p={toc:c};function u(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"anti-virus"},"Anti-Virus"),(0,r.kt)("p",null,"This document provides an overview of the anti-virus solutions employed by the MilMove project.\nMilMove uses an anti-virus scan utility called ",(0,r.kt)("a",{parentName:"p",href:"https://www.clamav.net"},"ClamAV"),"."),(0,r.kt)("p",null,"Anti-virus scanning is concerned with two parts of the system. The first part is viruses being injected into the source code of the project by folks with permissions to commit and merge code. The second part is viruses being uploaded to the AWS S3 bucket by users and downloaded by other users of the system."),(0,r.kt)("h2",{id:"source-code-scanning"},"Source Code Scanning"),(0,r.kt)("p",null,"Anti-virus scanning of the source code is done via a step in the CI/CD pipeline which in turn calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"make anti_virus")," target in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Makefile"),". The step uses a ClamAV Docker container to scan a copy of the checked out source code prior to building any binaries or docker images for deployment. If a virus is detected the build cannot continue and the anti-virus finding must be dealt with."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," This is only done on merge to master, not on every branch."),(0,r.kt)("h3",{id:"virus-findings"},"Virus Findings"),(0,r.kt)("p",null,"If a report of a virus is found to have been checked into the github repository by the CircleCI anti-virus job it must be assessed as a real threat. DO NOT ASSUME IT IS TEST FLAKINESS. Check out a fresh copy of the repository, assess with the anti-virus script using ",(0,r.kt)("inlineCode",{parentName:"p"},"make anti_virus")," and determine if the virus is indeed detected."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"NOTE:")," If scanning repeatedly find the virus then open an Incident first before doing anything else. An incident for a false positive result is better than no incident for a positive result."),(0,r.kt)("p",null,"During the incident get help in determining if the finding is a False Positive (read Troubleshooting below) or if it needs further action. Use the incident response procedures to move forward."),(0,r.kt)("h3",{id:"troubleshooting"},"Troubleshooting"),(0,r.kt)("h4",{id:"false-positives"},"False Positives"),(0,r.kt)("p",null,"Files and Signatures that are false positives (like PDF test fixtures) can be white-listed by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"scripts/anti-virus-whitelists")," script like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'export AV_DIR=$PWD\nexport AV_IGNORE_DIR=./anti-virus/\nexport AV_IGNORE_FILES=pkg/testdatagen/testdata/orders.pdf\nexport AV_IGNORE_SIGS="PUA.Pdf.Trojan.EmbeddedJavaScript-1 orders.pdf.UNOFFICIAL"\nanti-virus-whitelists\n')),(0,r.kt)("h4",{id:"outdated-clamav"},"Outdated ClamAV"),(0,r.kt)("p",null,"If you see this warning you can ignore it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Fri Mar  6 19:57:07 2020 -> ^Your ClamAV installation is OUTDATED!\nFri Mar  6 19:57:07 2020 -> ^Local version: 0.102.1 Recommended version: 0.102.2\nFri Mar  6 19:57:07 2020 -> DON'T PANIC! Read https://www.clamav.net/documents/upgrading-clamav\n")),(0,r.kt)("p",null,"The ClamAV maintainers have not yet released an official version for Debian Alpine. That doesn't stop the ClamAV process for trying to determine if there is a new version available and suggesting that you update. They helpfully added ",(0,r.kt)("inlineCode",{parentName:"p"},"DON'T PANIC!")," to try and dissuade folks from thinking this is the reason they are having trouble with ClamAV."),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mko-x/docker-clamav/issues/39"},"mko-x/docker-clamav#39")," for more information."),(0,r.kt)("h4",{id:"freshclam-container-exits-unpredictably"},"freshclam container exits unpredictably"),(0,r.kt)("p",null,"The freshclam process is used for updating various databases and definitions for virus detection. Here is some of that output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Fri Mar  6 19:57:07 2020 -> daily database available for download (remote version: 25743)\nFri Mar  6 19:57:11 2020 -> Testing database: '/store/tmp/clamav-6e94b769e8d37704da1bf78d7727231c.tmp-daily.cvd' ...\nFri Mar  6 19:57:22 2020 -> Database test passed.\nFri Mar  6 19:57:22 2020 -> daily.cvd updated (version: 25743, sigs: 2209759, f-level: 63, builder: raynman)\nFri Mar  6 19:57:22 2020 -> main database available for download (remote version: 59)\nFri Mar  6 19:57:29 2020 -> Testing database: '/store/tmp/clamav-e05bb84fe2271bf55ee55ee2506ff284.tmp-main.cvd' ...\nFri Mar  6 19:57:36 2020 -> Database test passed.\nFri Mar  6 19:57:36 2020 -> main.cvd updated (version: 59, sigs: 4564902, f-level: 60, builder: sigmgr)\nFri Mar  6 19:57:36 2020 -> bytecode database available for download (remote version: 331)\nFri Mar  6 19:57:36 2020 -> Testing database: '/store/tmp/clamav-8c552c424237331bd40cdba9db6f36ff.tmp-bytecode.cvd' ...\nFri Mar  6 19:57:36 2020 -> Database test passed.\nFri Mar  6 19:57:36 2020 -> bytecode.cvd updated (version: 331, sigs: 94, f-level: 63, builder: anvilleg)\nFri Mar  6 19:57:36 2020 -> safebrowsing database available for download (remote version: 49191)\nFri Mar  6 19:57:39 2020 -> Testing database: '/store/tmp/clamav-21790a79b7578c4fa0d73a103ab50d49.tmp-safebrowsing.cvd' ...\nFri Mar  6 19:57:43 2020 -> Database test passed.\nFri Mar  6 19:57:43 2020 -> safebrowsing.cvd updated (version: 49191, sigs: 2213119, f-level: 63, builder: google)\n")),(0,r.kt)("p",null,"Each update requires a network connection and for the website hosting the files to be available. If either the network is unstable or the website is unavailable then the docker container cannot continue startup and will exit."),(0,r.kt)("h4",{id:"how-do-i-get-inside-the-container-to-debug"},"How do I get inside the container to debug"),(0,r.kt)("p",null,"On your local computer you can just run ",(0,r.kt)("inlineCode",{parentName:"p"},"make anti_virus")," and wait until the script finishes. Once completed you can run the following command to drop into the container to debug:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"docker run -it --rm -v /tmp/store:/tmp/store -v $PWD:/root/project mk0x/docker-clamav:alpine /bin/bash\n")),(0,r.kt)("p",null,"This should drop you in a bash shell with the virus definitions at ",(0,r.kt)("inlineCode",{parentName:"p"},"/tmp/store")," and the project at ",(0,r.kt)("inlineCode",{parentName:"p"},"/root/project"),"."),(0,r.kt)("h2",{id:"upload-object-scanning-in-aws-s3"},"Upload Object Scanning in AWS S3"),(0,r.kt)("p",null,"Anti-virus scanning of uploads is done via an AWS Lambda that responds to AWS S3 Creation events to respond in real time to uploads and scan them immediately. The application and AWS users are forbidden from downloading unscanned files or files that have been marked as infected. Infected files also cannot be re-tagged as clean, preventing circumvention of the AV solution."),(0,r.kt)("h3",{id:"development"},"Development"),(0,r.kt)("p",null,"If you want to test this functionality on any of the deployed environments, you will need access to a file that will be marked as infected. ",(0,r.kt)("em",{parentName:"p"},"Ideally")," this can be done without dealing with any live viruses!  The most common\nway to test AV software is using ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/EICAR_test_file"},"EICAR test files"),', which are text files that begin with a specific string\nand are generally recognized by AV software as being "infected" with a fake virus. Unfortunately, EICAR files are plain text and\nas a result are rejected by the Milmove uploading code for not being one of the allowed content types (JPG, PNG, or PDF).'),(0,r.kt)("p",null,"Instead, we can use one of the test files that is provided by the ClamAV project itself. These test files are generated\nwhen the project is built and are not installed by the ",(0,r.kt)("inlineCode",{parentName:"p"},"clamav")," formula in homebrew and exhibit a similar behavior to EICAR\nfiles when scanned with ClamAV. To access them without needing to build the entire ClamAV project we can extract them from a Debian package."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Please don't check this file into our repository as it is under the GNU license and this project is not.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},"$ curl http://http.us.debian.org/debian/pool/main/c/clamav/clamav-testfiles_0.101.4+dfsg-1_all.deb -o clamav-testfiles_0.101.4+dfsg-1_all.deb\n$ ar x clamav-testfiles_0.101.4+dfsg-1_all.deb\n$ tar -xzvf data.tar.xz\n\n# The test files are available in ./usr/share/clamav-testfiles/\n")),(0,r.kt)("p",null,"You can use the PDF filed located within the directory used above at ",(0,r.kt)("inlineCode",{parentName:"p"},"usr/share/clamav-testfiles/clam.pdf"),". This file will\nbe flagged as containing ",(0,r.kt)("inlineCode",{parentName:"p"},"Clamav.Test.File-6")," by ClamAV."),(0,r.kt)("h3",{id:"object-tagging"},"Object Tagging"),(0,r.kt)("p",null,"The solution here relies on a terraform module named ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/trussworks/terraform-aws-s3-anti-virus"},"trussworks/terraform-aws-s3-anti-virus")," which deploys lambda code named ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/upsidetravel/bucket-antivirus-function"},"upsidetravel/bucket-antivirus-function"),".  The lambda adds tags ",(0,r.kt)("inlineCode",{parentName:"p"},"av-status"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"av-timestamp")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"av-signature")," to the object with the following key/values:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Key"),(0,r.kt)("th",{parentName:"tr",align:null},"Values"),(0,r.kt)("th",{parentName:"tr",align:null},"Notes"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"av-status"),(0,r.kt)("td",{parentName:"tr",align:null},"CLEAN/INFECTED"),(0,r.kt)("td",{parentName:"tr",align:null},"No other values are allowed")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"av-timestamp"),(0,r.kt)("td",{parentName:"tr",align:null},"RFC 3339 timestamp"),(0,r.kt)("td",{parentName:"tr",align:null},"This is a string")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"av-signature"),(0,r.kt)("td",{parentName:"tr",align:null},"ClamAV Signature String"),(0,r.kt)("td",{parentName:"tr",align:null},"This is the finding result for the file")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"av-notes"),(0,r.kt)("td",{parentName:"tr",align:null},"GENERATED/MANUAL"),(0,r.kt)("td",{parentName:"tr",align:null},"Notes not added by the lambda but via the application or other scripts")))),(0,r.kt)("p",null,"The application or manual scripts can also be invoked to scan files or mark them as known to be CLEAN. These tools are requested to add a tag ",(0,r.kt)("inlineCode",{parentName:"p"},"av-notes")," for auditing purposes. However, no other values for ",(0,r.kt)("inlineCode",{parentName:"p"},"av-status")," other than ",(0,r.kt)("inlineCode",{parentName:"p"},"CLEAN")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"INFECTED")," are allowed."),(0,r.kt)("h3",{id:"scanned-buckets"},"Scanned buckets"),(0,r.kt)("p",null,"The scanned buckets include:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"transcom-ppp-app-devlocal-us-west-2"),(0,r.kt)("li",{parentName:"ul"},"transcom-ppp-app-experimental-us-west-2"),(0,r.kt)("li",{parentName:"ul"},"transcom-ppp-app-staging-us-west-2"),(0,r.kt)("li",{parentName:"ul"},"transcom-ppp-app-prod-us-west-2")),(0,r.kt)("p",null,"All key-prefixes are scanned in these buckets including ",(0,r.kt)("inlineCode",{parentName:"p"},"app/")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"secure-migrations/"),". In all cases the threat is that a user uploads a file that is downloaded by another user and infects their machine. There is a threat model around an ECS container handling viruses (like migrations) but this is not the primary reason all these objects are scanned."))}u.isMDXComponent=!0}}]);