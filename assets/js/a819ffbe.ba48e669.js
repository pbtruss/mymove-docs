"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[1536],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return g}});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var d=r.createContext({}),l=function(e){var t=r.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(d.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,d=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=l(n),g=i,m=p["".concat(d,".").concat(g)]||p[g]||u[g]||a;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=p;var s={};for(var d in t)hasOwnProperty.call(t,d)&&(s[d]=t[d]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<a;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},3167:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return d},metadata:function(){return l},toc:function(){return c},default:function(){return p}});var r=n(7462),i=n(3366),a=(n(7294),n(3905)),o=["components"],s={},d="What Is Optimistic Locking?",l={unversionedId:"old-wiki/use-optimistic-locking",id:"old-wiki/use-optimistic-locking",isDocsHomePage:!1,title:"What Is Optimistic Locking?",description:"Optimistic locking is a strategy to avoid conflicts when multiple people may be editing a single record. Before committing a change, the system checks to make sure the record hasn't been updated before committing the update. For more information, check out the Wikipedia page and this MDN section on avoiding mid-air collisions.",source:"@site/docs/old-wiki/use-optimistic-locking.md",sourceDirName:"old-wiki",slug:"/old-wiki/use-optimistic-locking",permalink:"/docs/old-wiki/use-optimistic-locking",editUrl:"https://github.com/facebook/docusaurus/edit/main/website/docs/old-wiki/use-optimistic-locking.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to Create CAC Access (for using Prime API and uploading Electronic Orders)",permalink:"/docs/old-wiki/use-mtls-with-cac"},next:{title:"Useful Links",permalink:"/docs/old-wiki/useful-links"}},c=[{value:"Leaning on the query builder",id:"leaning-on-the-query-builder",children:[]},{value:"How to use optimistic locking on the front-end",id:"how-to-use-optimistic-locking-on-the-front-end",children:[]}],u={toc:c};function p(e){var t=e.components,n=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"what-is-optimistic-locking"},"What Is Optimistic Locking?"),(0,a.kt)("p",null,"Optimistic locking is a strategy to avoid conflicts when multiple people may be editing a single record. Before committing a change, the system checks to make sure the record hasn't been updated before committing the update. For more information, check out the ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Optimistic_concurrency_control"},"Wikipedia page")," and ",(0,a.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag#avoiding_mid-air_collisions"},"this MDN section on avoiding mid-air collisions"),"."),(0,a.kt)("h1",{id:"how-to-use-optimistic-locking-with-e-tags"},"How To Use Optimistic Locking (With E-Tags)"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Note: you'll probably want to use this on ",(0,a.kt)("inlineCode",{parentName:"em"},"PUT")," or ",(0,a.kt)("inlineCode",{parentName:"em"},"PATCH")," endpoints only.")),(0,a.kt)("h2",{id:"leaning-on-the-query-builder"},"Leaning on the query builder"),(0,a.kt)("p",null,"Let's say you're building out a new endpoint that needs optimistic locking to avoid people updating stale data. You have a handler and a service object, let's call them ",(0,a.kt)("inlineCode",{parentName:"p"},"WidgetHandler")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"WidgetUpdater")," respectively. The ",(0,a.kt)("inlineCode",{parentName:"p"},"WidgetUpdater")," is going to take care of the business logic. Let's take a look at the handler first:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"type PatchWidgetHandler struct {\n  //...\n  services.WidgetUpdater\n}\n\n\nfunc (h PatchWidgetHandler) Handle(params widgetops.PatchWidgetParams) middleware.Responder {\n  //...\n\n  eTag := params.IfMatch\n\n  widget := h.UpdateWidget(someArg, eTag)\n\n  //...\n}\n")),(0,a.kt)("p",null,"We're grabbing the E-tag from the ",(0,a.kt)("inlineCode",{parentName:"p"},"If-Match")," header, and passing it along to the\nservice object. Meanwhile, in the service object:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"type widgetUpdater struct {\n  //...\n  builder QueryBuilder\n}\n\nfunc (w *widgetUpdater) UpdateWidget(someArg interface{}, eTag string) {\n  var widget models.Widget\n  //...\n\n  verrs, err := w.builder.UpdateOne(&widget, &eTag)\n}\n\ntype PreconditionFailedError struct {\n  id  uuid.UUID\n  Err error\n}\n\nfunc (e PreconditionFailedError) Error() string {\n  return fmt.Sprintf(\"widget with id: '%s' could not be updated due to the record being stale\", e.id.String())\n}\n")),(0,a.kt)("p",null,"You'll notice that ",(0,a.kt)("inlineCode",{parentName:"p"},"UpdateOne"),", a function that takes a model struct as an\n",(0,a.kt)("inlineCode",{parentName:"p"},"interface{}")," in order to find the record and update it, now takes an optional\n",(0,a.kt)("inlineCode",{parentName:"p"},"string")," argument for an E-tag. If the supplied E-tag is stale, ",(0,a.kt)("inlineCode",{parentName:"p"},"UpdateOne")," will\nreturn a ",(0,a.kt)("inlineCode",{parentName:"p"},"query.StaleIdentifierError")," that you can then use to return a ",(0,a.kt)("inlineCode",{parentName:"p"},"412\nPrecondition Failed")," in the handler:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//...\nwidget, err := h.UpdateWidget(someArg, eTag)\nif err != nil {\n  logger.Error("error: ", zap.Error(err))\n\n  switch e := err.(type) {\n  case widget.NotFoundError:\n    return widgetops.NewPatchWidgetNotFound()\n  case widget.PreconditionFailedError:\n    return widgetops.NewPatchWidgetPreconditionFailed()\n  default:\n    return widgetops.NewPatchWidgetInternalServerError()\n  }\n}\n\nreturn widgetops.NewPatchWidgetOk().WithPayload(widget) // make sure payload includes updated E-tag.\n//...\n')),(0,a.kt)("h2",{id:"how-to-use-optimistic-locking-on-the-front-end"},"How to use optimistic locking on the front-end"),(0,a.kt)("p",null,"Luckily, once we've added the ",(0,a.kt)("inlineCode",{parentName:"p"},"eTag")," key to our Swagger configuration, it's\nautomatically stored in the Redux state. All we have to do is pull it out of the\nRedux state when we need it."),(0,a.kt)("p",null,"Let's say we need to make an update to an MTO's status. First, we'll need to\nvisit the entity file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// src/shared/Entities/modules/moveTaskOrders.js\n\n//...\n\n\nconst updateMoveTaskOrders = 'moveTaskOrder.updateMoveTaskOrderStatus';\nexport function updateMoveTaskOrderStatus(\n  moveTaskOrderID,\n  isAvailableToPrime,\n  label = updateMoveTaskOrders,\n) {\n  const swaggerTag = 'moveTaskOrder.updateMoveTaskOrderStatus';\n  return swaggerRequest(\n    getGHCClient,\n    swaggerTag,\n    { moveTaskOrderID },\n    { updateMoveTaskOrders },\n  );\n}\n\n//...\n")),(0,a.kt)("p",null,"We need to make sure this function takes an ETag as an argument and passes it\nalong in the ",(0,a.kt)("inlineCode",{parentName:"p"},"If-Match")," header:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// src/shared/Entities/modules/moveTaskOrders.js\n\n//...\n\n\nconst updateMoveTaskOrders = 'moveTaskOrder.updateMoveTaskOrderStatus';\nexport function updateMoveTaskOrderStatus(\n  moveTaskOrderID,\n  ifMatchETag,\n  isAvailableToPrime,\n  label = updateMoveTaskOrders,\n) {\n  const swaggerTag = 'moveTaskOrder.updateMoveTaskOrderStatus';\n  return swaggerRequest(\n    getGHCClient,\n    swaggerTag,\n    { moveTaskOrderID, 'If-Match': ifMatchETag },\n    { updateMoveTaskOrders },\n  );\n}\n\n//...\n")),(0,a.kt)("p",null,"Now we need to find where this function is actually being called. It looks like\nit's being used as the callback for a button click:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// src/scenes/Office/TOO/customerDetails.jsx\n\n//...\n\n\n<button\n  data-hi={moveTaskOrder.eTag}\n  onClick={() => this.props.updateMoveTaskOrderStatus(moveTaskOrder.id)}\n>\n  Send to Prime\n</button>\n\n//...\n")),(0,a.kt)("p",null,"We'll need to supply the ETag as an argument:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"// src/scenes/Office/TOO/customerDetails.jsx\n\n//...\n\n\n<button\n  onClick={() => this.props.updateMoveTaskOrderStatus(moveTaskOrder.id, moveTaskOrder.eTag)}\n>\n  Send to Prime\n</button>\n\n//...\n")),(0,a.kt)("p",null,"You should now be able to update the move task order without getting that pesky\n",(0,a.kt)("inlineCode",{parentName:"p"},"412 Precondition Failed")," error."))}p.isMDXComponent=!0}}]);