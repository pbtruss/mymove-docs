"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[9051],{3905:function(e,t,o){o.d(t,{Zo:function(){return c},kt:function(){return p}});var n=o(67294);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var s=n.createContext({}),d=function(e){var t=n.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},c=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=d(o),p=a,h=m["".concat(s,".").concat(p)]||m[p]||u[p]||r;return o?n.createElement(h,i(i({ref:t},c),{},{components:o})):n.createElement(h,i({ref:t},c))}));function p(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var d=2;d<r;d++)i[d]=o[d];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}m.displayName="MDXCreateElement"},85754:function(e,t,o){o.r(t),o.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return d},toc:function(){return c},default:function(){return m}});var n=o(87462),a=o(63366),r=(o(67294),o(3905)),i=["components"],l={sidebar_position:9},s="How to Soft Delete",d={unversionedId:"backend/guides/how-to/soft-delete",id:"backend/guides/how-to/soft-delete",isDocsHomePage:!1,title:"How to Soft Delete",description:"Due to our contractual obligations with the federal government, we must be able to access deleted data even several years after it\u2019s been used in the system. For this reason, MilMove is shifting away from hard deleting data and adopting the practice to soft delete instead. Soft delete functionality has not yet been implemented throughout the entire codebase but it is expected to be the sole deletion method moving forward.",source:"@site/docs/backend/guides/how-to/soft-delete.md",sourceDirName:"backend/guides/how-to",slug:"/backend/guides/how-to/soft-delete",permalink:"/mymove-docs/docs/backend/guides/how-to/soft-delete",editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/guides/how-to/soft-delete.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9},sidebar:"backendSidebar",previous:{title:"How to revert a change",permalink:"/mymove-docs/docs/backend/guides/how-to/revert-a-change"},next:{title:"How to Upgrade Go Version",permalink:"/mymove-docs/docs/backend/guides/how-to/upgrade-go-version"}},c=[{value:"How Soft Delete Works",id:"how-soft-delete-works",children:[]},{value:"Prerequisites for Soft Delete",id:"prerequisites-for-soft-delete",children:[]},{value:"Querying for non-deleted records",id:"querying-for-non-deleted-records",children:[]},{value:"Using Soft Delete",id:"using-soft-delete",children:[]}],u={toc:c};function m(e){var t=e.components,o=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-to-soft-delete"},"How to Soft Delete"),(0,r.kt)("p",null,"Due to our contractual obligations with the federal government, we must be able to access deleted data even several years after it\u2019s been used in the system. For this reason, MilMove is shifting away from hard deleting data and adopting the practice to soft delete instead. Soft delete functionality has not yet been implemented throughout the entire codebase but it is expected to be the sole deletion method moving forward."),(0,r.kt)("p",null,"Please note that soft delete is to be treated like a hard delete in the regard that the process should never be reversed or that data can be 'un-deleted'."),(0,r.kt)("h2",{id:"how-soft-delete-works"},"How Soft Delete Works"),(0,r.kt)("p",null,"MilMove's implementation of soft delete takes in a model, sets a time stamp to its ",(0,r.kt)("inlineCode",{parentName:"p"},"DeletedAt")," field, before cascading down to its children and repeating the process until there are no longer children to 'delete'."),(0,r.kt)("h2",{id:"prerequisites-for-soft-delete"},"Prerequisites for Soft Delete"),(0,r.kt)("p",null,"To use soft delete, a model and its children (or foreign key associations) must possess a ",(0,r.kt)("inlineCode",{parentName:"p"},"DeletedAt")," field that corresponds to the ",(0,r.kt)("inlineCode",{parentName:"p"},"deleted_at")," column of their table within the database."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'type ExampleModel struct {\n    ...\n    DeletedAt   *time.Time  `db:"deleted_at"`\n\n}\n')),(0,r.kt)("p",null,"If this has not been done, one must ",(0,r.kt)("a",{parentName:"p",href:"migrate-the-database.md"},"create a migration")," to make these changes."),(0,r.kt)("h2",{id:"querying-for-non-deleted-records"},"Querying for non-deleted records"),(0,r.kt)("p",null,"Records that have been soft deleted will still exist in the database, so we must filter them out in our database queries if we want to omit deleted data."),(0,r.kt)("p",null,"The Pop ORM has a chain-able method called ",(0,r.kt)("a",{parentName:"p",href:"https://gobuffalo.io/documentation/database/scoping/"},"Scope")," that we can use to append the where clause(s) to only include non-deleted records."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func FindShipment(ctx context.Context, shipmentID uuid.UUID) {\n    var shipments models.MTOShipments\n    ctx.DB().Scope(utilities.ExcludeDeletedScope()).All(&shipments)\n}\n")),(0,r.kt)("p",null,"Sometimes you will need to qualify the deleted_at column with the model(s) that you care about to avoid an ambiguous column SQL error. You can achieve this by passing in the models themselves to the ExcludeDeletedScope method. ExcludeDeletedScope will look up the proper table name of the model, using either reflection or the TableName() override specified in the model file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func FindDocumentsWithUploads(ctx context.Context, uploaderID uuid.UUID) {\n    var documents models.Documents\n    ctx.DB().Scope(utilities.ExcludeDeletedScope(models.Document{}, models.UserUpload{})).\n        Join("user_uploads", "user_uploads.document_id = documents.id").\n        All(&documents)\n}\n')),(0,r.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Unfortunately this will not filter any eager loaded associations, you will still need to iterate through the results and filter them out or append them separately."),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-go"},"// This will not filter the eagerly loaded MTOShipments\nfunc FindMoveWithShipments(ctx context.Context, moveID uuid.UUID) {\n    var move models.Move\n    ctx.DB().Scope(utilities.ExcludeDeletedScope(models.MTOShipment{})).Eager(MTOShipments).Find(&move, moveID)\n}\n")),(0,r.kt)("p",{parentName:"div"},"You should fall back to using a normal where clause if using an alias in your query or writing a RawQuery."),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// If a table is given an alias name then the scope may fail to work as intended\nfunc FindAllServiceMembersWithDocuments(ctx context.Context) {\n    var serviceMembers []models.ServiceMember\n    ctx.DB().Scope(utilities.ExcludeDeletedScope(models.Document{}, models.UserUpload{}).\n        Join("documents docs", "documents.service_member_id = service_members.id").\n        Join("user_uploads uu", "uu.document_id = docs.id").\n        All(&serviceMembers);\n}\n')))),(0,r.kt)("p",null,"For further details you can find the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/transcom/mymove/blob/0002defdbdeebf29c3afdaa1fd939dc457071a3d/pkg/db/utilities/utilities.go#L150"},"ExcludeDeletedScope")," code in the pkg/db/utilities/utilities.go file."),(0,r.kt)("h2",{id:"using-soft-delete"},"Using Soft Delete"),(0,r.kt)("p",null,"In order to use MilMove's soft delete method, one must import the following package"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'package models\n\nimport (\n    "github.com/transcom/mymove/pkg/db/utilities"\n)\n')),(0,r.kt)("p",null,"It is recommended that any use of soft delete be wrapped in a transaction. This is to rollback the deletion should any error arise."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func DeleteExampleModel(db *pop.Connection, exampleModel *ExampleModel) error {\n    return db.Transaction(func(db *pop.Connection) error {\n        return utilities.SoftDestroy(db, exampleModel)\n    })\n}\n")))}m.isMDXComponent=!0}}]);