"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[2169],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>m});var s=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,s,r=function(e,t){if(null==e)return{};var n,s,r={},a=Object.keys(e);for(s=0;s<a.length;s++)n=a[s],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(s=0;s<a.length;s++)n=a[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=s.createContext({}),c=function(e){var t=s.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},l=function(e){var t=c(e.components);return s.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},p=s.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,u=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||a;return n?s.createElement(f,o(o({ref:t},l),{},{components:n})):s.createElement(f,o({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=p;var i={};for(var u in t)hasOwnProperty.call(t,u)&&(i[u]=t[u]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var c=2;c<a;c++)o[c]=n[c];return s.createElement.apply(null,o)}return s.createElement.apply(null,n)}p.displayName="MDXCreateElement"},44881:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var s=n(87462),r=(n(67294),n(3905));const a={sidebar_position:7},o="How to write fast tests",i={unversionedId:"backend/testing/how-to-write-fast-tests",id:"backend/testing/how-to-write-fast-tests",title:"How to write fast tests",description:"Use stubbed models",source:"@site/docs/backend/testing/how-to-write-fast-tests.md",sourceDirName:"backend/testing",slug:"/backend/testing/how-to-write-fast-tests",permalink:"/mymove-docs/docs/backend/testing/how-to-write-fast-tests",draft:!1,editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/backend/testing/how-to-write-fast-tests.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"backendSidebar",previous:{title:"How to run Go tests",permalink:"/mymove-docs/docs/backend/testing/run-go-tests"},next:{title:"Interacting with the database in Go server tests",permalink:"/mymove-docs/docs/backend/testing/interacting-with-the-db-in-go-server-tests"}},u={},c=[{value:"Use stubbed models",id:"use-stubbed-models",level:2},{value:"Use mocks when testing response types in handler tests",id:"use-mocks-when-testing-response-types-in-handler-tests",level:2},{value:"Authorization Test Example",id:"authorization-test-example",level:3},{value:"Example of testing an error scenario",id:"example-of-testing-an-error-scenario",level:3}],l={toc:c};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,s.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"how-to-write-fast-tests"},"How to write fast tests"),(0,r.kt)("h2",{id:"use-stubbed-models"},"Use stubbed models"),(0,r.kt)("p",null,"In many cases, we don't need to save models in the database. The less we use the DB, the faster our tests. For example, there are many tests that create a user only to pass it to the ",(0,r.kt)("inlineCode",{parentName:"p"},"suite.AuthenticateUserRequest")," function. That function doesn't care whether or not the user exists in the DB. It uses the user to set Session variables so we can simulate an authenticated user. In these cases, you should use the ",(0,r.kt)("inlineCode",{parentName:"p"},"MakeStubbedUser")," function in testdatagen."),(0,r.kt)("p",null,"For tests that use other models but don't need them in the DB, you can stub them by passing in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Stub: true")," assertion, like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-golang"},"officeUser := testdatagen.MakeTOOOfficeUser(suite.DB(), testdatagen.Assertions{\n    Stub: true,\n})\n")),(0,r.kt)("p",null,"If you find that you are passing in ",(0,r.kt)("inlineCode",{parentName:"p"},"Stub: true")," to the same model in many places, you might consider making a named helper function, such as ",(0,r.kt)("inlineCode",{parentName:"p"},"MakeStubbedOfficeUser")," and placing it in the appropriate file in ",(0,r.kt)("inlineCode",{parentName:"p"},"pkg/testdatagen"),"."),(0,r.kt)("h2",{id:"use-mocks-when-testing-response-types-in-handler-tests"},"Use mocks when testing response types in handler tests"),(0,r.kt)("p",null,"If the purpose of a handler test is to verify that the appropriate response is returned, the DB is not needed. All models can be stubbed, and functions that call the DB can be mocked to return the desired data or errors. We use the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/stretchr/testify#mock-package"},"stretchr/testify")," mocking library."),(0,r.kt)("h3",{id:"authorization-test-example"},"Authorization Test Example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-golang"},'suite.T().Run("When office user is not TOO, response should be 403", func(t *testing.T) {\n    moveOrderFetcher := &mocks.MoveOrderFetcher{}\n    officeUser := testdatagen.MakeOfficeUser(suite.DB(), testdatagen.Assertions{\n      Stub: true,\n    })\n\n    req := httptest.NewRequest("GET", fmt.Sprintf("/move_orders"), nil)\n    req = suite.AuthenticateOfficeRequest(req, officeUser)\n\n    params := moveorderop.ListMoveOrdersParams{\n      HTTPRequest: req,\n    }\n\n    handler := ListMoveOrdersHandler{\n      handlers.NewHandlerConfig(suite.DB(), suite.TestLogger()),\n      moveOrderFetcher,\n    }\n    response := handler.Handle(params)\n\n    suite.IsType(&moveorderop.ListMoveOrdersForbidden{}, response)\n})\n')),(0,r.kt)("h3",{id:"example-of-testing-an-error-scenario"},"Example of testing an error scenario"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-golang"},'suite.T().Run("failed fetch of payment requests", func(t *testing.T) {\n    paymentRequestListFetcher := &mocks.PaymentRequestListFetcher{}\n    officeUser := testdatagen.MakeTIOOfficeUser(suite.DB(), testdatagen.Assertions{\n      Stub: true,\n    })\n    paymentRequestListFetcher.On("FetchPaymentRequestList", officeUser.ID).Return(nil, errors.New("test failed to create with err returned")).Once()\n\n    req := httptest.NewRequest("GET", fmt.Sprintf("/payment_requests"), nil)\n    req = suite.AuthenticateOfficeRequest(req, officeUser)\n    params := paymentrequestop.ListPaymentRequestsParams{\n      HTTPRequest: req,\n    }\n\n    handler := ListPaymentRequestsHandler{\n      handlers.NewHandlerConfig(suite.DB(), suite.TestLogger()),\n      paymentRequestListFetcher,\n    }\n    response := handler.Handle(params)\n\n    suite.IsType(&paymentrequestop.ListPaymentRequestsInternalServerError{}, response)\n})\n')))}d.isMDXComponent=!0}}]);