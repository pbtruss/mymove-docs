"use strict";(self.webpackChunkmymove_docs=self.webpackChunkmymove_docs||[]).push([[1416],{3905:function(e,t,o){o.d(t,{Zo:function(){return p},kt:function(){return d}});var n=o(67294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},k=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),k=u(o),d=r,m=k["".concat(l,".").concat(d)]||k[d]||c[d]||a;return o?n.createElement(m,i(i({ref:t},p),{},{components:o})):n.createElement(m,i({ref:t},p))}));function d(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=k;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var u=2;u<a;u++)i[u]=o[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}k.displayName="MDXCreateElement"},41:function(e,t,o){o.r(t),o.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return p},default:function(){return k}});var n=o(87462),r=o(63366),a=(o(67294),o(3905)),i=["components"],s={},l=void 0,u={unversionedId:"vault/[deprecated]-run-loki-tests-against-storybook",id:"vault/[deprecated]-run-loki-tests-against-storybook",isDocsHomePage:!1,title:"[deprecated]-run-loki-tests-against-storybook",description:"This is for historical reference only. We no longer use Loki",source:"@site/docs/vault/[deprecated]-run-loki-tests-against-storybook.md",sourceDirName:"vault",slug:"/vault/[deprecated]-run-loki-tests-against-storybook",permalink:"/mymove-docs/docs/vault/[deprecated]-run-loki-tests-against-storybook",editUrl:"https://github.com/transcom/mymove-docs/edit/main/docs/vault/[deprecated]-run-loki-tests-against-storybook.md",tags:[],version:"current",frontMatter:{},sidebar:"vaultSidebar",previous:{title:"Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox",permalink:"/mymove-docs/docs/vault/Setting-up-Internet-Explorer-11---Edge-Browser-in-Virtualbox"},next:{title:"How to Automatically add JIRA ID to Commit Message",permalink:"/mymove-docs/docs/vault/confluence/automatically-add-jira-id-to-commit-message"}},p=[{value:"Running tests locally",id:"running-tests-locally",children:[{value:"Pre-requisites",id:"pre-requisites",children:[]},{value:"Running Loki Tests",id:"running-loki-tests",children:[]},{value:"If there are expected failures",id:"if-there-are-expected-failures",children:[]}]},{value:"Running loki update",id:"running-loki-update",children:[{value:"Running loki update in docker",id:"running-loki-update-in-docker",children:[]}]},{value:"Skipping loki tests for a story",id:"skipping-loki-tests-for-a-story",children:[]}],c={toc:p};function k(e){var t=e.components,o=(0,r.Z)(e,i);return(0,a.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"This is for historical reference only. We no longer use Loki")),(0,a.kt)("h1",{id:"how-to-run-loki-tests-against-storybook"},"How to Run Loki Tests Against Storybook"),(0,a.kt)("p",null,"MilMove uses ",(0,a.kt)("a",{parentName:"p",href:"https://loki.js.org/"},"Loki")," for testing stories in storybook to ensure they have not changed. You can run the tests locally for verification using this document."),(0,a.kt)("h2",{id:"running-tests-locally"},"Running tests locally"),(0,a.kt)("h3",{id:"pre-requisites"},"Pre-requisites"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"You will need to be able to run storybook locally. See ",(0,a.kt)("a",{parentName:"li",href:"run-storybook.md"},"How to Run Storybook")," for details."),(0,a.kt)("li",{parentName:"ul"},"You will need Docker for Mac running locally as well. You can install the latest stable version from ",(0,a.kt)("a",{parentName:"li",href:"https://download.docker.com/mac/stable/Docker.dmg"},"here"),".",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Detailed instructions for installation can be found in the ",(0,a.kt)("a",{parentName:"li",href:"https://docs.docker.com/docker-for-mac/install/"},"Docker for Mac Documentation"))))),(0,a.kt)("h3",{id:"running-loki-tests"},"Running Loki Tests"),(0,a.kt)("p",null,"Ensuring that you do not have storybook running in a separate window, run storybook tests:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"make storybook_tests\n")),(0,a.kt)("p",null,"Sample output"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"\u276f make storybook_tests\nyarn run loki test\nyarn run v1.19.0\n$ /Users/john/projects/dod/mymove/node_modules/.bin/loki test\nloki test v0.18.1\n  \u2714 Chrome (docker)\n\u2728  Done in 12.02s.\n")),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"NOTE")," If you are seeing strange failures in loki tests you can reduce ",(0,a.kt)("inlineCode",{parentName:"p"},"CHROME_CONCURRENCY")," from 4 locally to 2 in the ",(0,a.kt)("inlineCode",{parentName:"p"},"docker-compose.storybook_local.yml")," file and see if that helps."),(0,a.kt)("h3",{id:"if-there-are-expected-failures"},"If there are expected failures"),(0,a.kt)("p",null,"If you are working on a storybook story and have finished making changes to the story or the components used the above command will fail. You should review the results files stored in ",(0,a.kt)("inlineCode",{parentName:"p"},".loki/current"),", ",(0,a.kt)("inlineCode",{parentName:"p"},".loki/reference"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},".loki/difference")," directories."),(0,a.kt)("p",null,"If the changes are as expected, you will need to start the storybook server locally first (see instructions below for Running loki update), then run the following command to update the reference files."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"make loki_approve_changes\n")),(0,a.kt)("h2",{id:"running-loki-update"},"Running loki update"),(0,a.kt)("p",null,"You may see errors as below when running ",(0,a.kt)("inlineCode",{parentName:"p"},"make storybook_tests")," or in CI."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'storybook_tests_1  |  FAIL  chrome.app/chrome.laptop/Components|TabNav\nstorybook_tests_1  |        default\nstorybook_tests_1  |        Invalid file signature\nstorybook_tests_1  |        withTag\nstorybook_tests_1  |        No reference image found\n...\nstorybook_tests_1  |  FAIL  chrome.app/chrome.iphone7/Samples|Form\nstorybook_tests_1  |        personal info\nstorybook_tests_1  |        Invalid file signature\nstorybook_tests_1  |  RUNS  chrome.app: Running tests\nstorybook_tests_1  |  FAIL  chrome.app\nstorybook_tests_1  | Visual tests failed\nstorybook_tests_1  | You can update the reference files with:\nstorybook_tests_1  | loki update --storiesFilter="^Components\\\\|TabNav withTag\\$" --host="storybook"\nstorybook_tests_1  | error Command failed with exit code 1.\n')),(0,a.kt)("p",null,"If you do you will need to do the following to resolve it"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Start storybook server locally ",(0,a.kt)("inlineCode",{parentName:"li"},"make storybook_docker")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"yarn storybook")),(0,a.kt)("li",{parentName:"ul"},"Run ",(0,a.kt)("inlineCode",{parentName:"li"},'yarn loki update --storiesFilter="^Components\\\\|TabNav withTag\\$"')," ",(0,a.kt)("strong",{parentName:"li"},"NOTE")," You will need to update the filter as described in the error message"),(0,a.kt)("li",{parentName:"ul"},"Run ",(0,a.kt)("inlineCode",{parentName:"li"},"make storybook_tests"),", this may still fail as the above will run the update outside of docker"),(0,a.kt)("li",{parentName:"ul"},"Run ",(0,a.kt)("inlineCode",{parentName:"li"},"make loki_approve_changes")),(0,a.kt)("li",{parentName:"ul"},"Commit the new or changed ",(0,a.kt)("inlineCode",{parentName:"li"},".loki/reference")," images.")),(0,a.kt)("h3",{id:"running-loki-update-in-docker"},"Running loki update in docker"),(0,a.kt)("p",null,"If you need to run ",(0,a.kt)("inlineCode",{parentName:"p"},"yarn loki update")," you can do so in docker using the following steps"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Make sure you have the storybook image built (NOTE if you have run ",(0,a.kt)("inlineCode",{parentName:"li"},"make storybook_tests")," recently you don't need to do this), run ",(0,a.kt)("inlineCode",{parentName:"li"},"docker-compose -f docker-compose.storybook.yml -f docker-compose.storybook_local.yml build --pull storybook")),(0,a.kt)("li",{parentName:"ul"},"Open a shell session inside a docker container ",(0,a.kt)("inlineCode",{parentName:"li"},"docker run -v /Users/<yourusername>/projects/dod/mymove/.loki:/home/circleci/project/.loki -it --rm mymove_storybook bash")),(0,a.kt)("li",{parentName:"ul"},"Start storybook in the background ",(0,a.kt)("inlineCode",{parentName:"li"},"yarn storybook --ci &")),(0,a.kt)("li",{parentName:"ul"},"Run update or other loki command ",(0,a.kt)("inlineCode",{parentName:"li"},"yarn loki update")),(0,a.kt)("li",{parentName:"ul"},"Run ",(0,a.kt)("inlineCode",{parentName:"li"},"exit")," to leave the container")),(0,a.kt)("h2",{id:"skipping-loki-tests-for-a-story"},"Skipping loki tests for a story"),(0,a.kt)("p",null,"Sometimes you may want to exclude a single story or component from running visual regression tests because of flaky results.  We'll assume you are using the newer ",(0,a.kt)("a",{parentName:"p",href:"https://storybook.js.org/docs/formats/component-story-format/"},"Component Story Format")," instead of the deprecated ",(0,a.kt)("inlineCode",{parentName:"p"},"storiesOf")," way of doing things."),(0,a.kt)("p",null,"To skip all of the stories of a particular component you should add the skip flag to the default parameters block:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"export default {\n  title: 'Components|Component Name',\n  component: ComponentName,\n  parameters: { loki: { skip: true } },\n};\n\nexport const Simple = () => (\n...\n);\n")),(0,a.kt)("p",null,"To skip only an individual story, attach the parameters to the exported story object:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx"},"export default {\n  title: 'Components|Component Name',\n  component: ComponentName,\n};\n\nexport const Simple = () => (\n...\n);\n\nSimple.story = {\n    parameters: { loki: { skip: true } },\n};\n")))}k.isMDXComponent=!0}}]);